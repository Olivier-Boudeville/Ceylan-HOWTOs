<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.21.2: https://docutils.sourceforge.io/" />
<title>Ceylan-HOWTOs: About Erlang</title>
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="howtos.css" type="text/css" />
<link href="howtos-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="erlang">
<span id="top"></span>
<h1 class="title">Erlang</h1>

<p><span class="raw-html"><a name="howtos_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Ceylan HOWTOs</em> <a href="http://howtos.esperide.org">browse latest</a> <a href="Ceylan-HOWTOs-english.pdf">get PDF</a> <a href="#howtos_top">go to top</a> <a href="#howtos_toc">go to toc</a> <a href="#howtos_bottom">go to bottom</a> <a href="Ceylan-HOWTOs-overview-english.html">go to HOWTOs</a> <a href="mailto:about(dash)ceylan-howtos(at)esperide(dot)com?subject=[Ceylan-HOWTOs]%20Remark%20about%20Erlang">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="howtos-title.png" id="responsive-image-ultrasmall"></img></span></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body">Copyright (C) 2021-2024 Olivier Boudeville</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body">about (dash) howtos (at) esperide (dot) com</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body">Saturday, November 20, 2021</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Monday, May 20, 2024</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"><a name="howtos_toc"></a></span></p>
<div class="contents local topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><a class="reference internal" href="#top"><strong>Table of Contents</strong></a></p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="toc-entry-1">Overview</a></li>
<li><a class="reference internal" href="#let-s-start-with-some-shameless-advertisement-for-erlang-and-the-beam-vm" id="toc-entry-2">Let's Start with some Shameless Advertisement for Erlang and the BEAM VM</a></li>
<li><a class="reference internal" href="#installation" id="toc-entry-3">Installation</a></li>
<li><a class="reference internal" href="#ceylan-s-language-use" id="toc-entry-4">Ceylan's Language Use</a></li>
<li><a class="reference internal" href="#using-the-shell" id="toc-entry-5">Using the Shell</a></li>
<li><a class="reference internal" href="#about-security" id="toc-entry-6">About Security</a></li>
<li><a class="reference internal" href="#otp-guidelines" id="toc-entry-7">OTP Guidelines</a><ul>
<li><a class="reference internal" href="#the-app-specification" id="toc-entry-8">The <tt class="docutils literal">.app</tt> Specification</a></li>
<li><a class="reference internal" href="#starting-otp-applications" id="toc-entry-9">Starting OTP Applications</a></li>
<li><a class="reference internal" href="#pre-launch-functions" id="toc-entry-10">Pre-Launch Functions</a></li>
<li><a class="reference internal" href="#otp-supervisors" id="toc-entry-11">OTP Supervisors</a></li>
<li><a class="reference internal" href="#declaring-worker-processes" id="toc-entry-12">Declaring Worker Processes</a></li>
<li><a class="reference internal" href="#implementing-worker-processes" id="toc-entry-13">Implementing Worker Processes</a></li>
<li><a class="reference internal" href="#terminating-workers" id="toc-entry-14">Terminating Workers</a></li>
<li><a class="reference internal" href="#supervisor-bridges" id="toc-entry-15">Supervisor Bridges</a></li>
<li><a class="reference internal" href="#extra-information" id="toc-entry-16">Extra Information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-advanced-topics" id="toc-entry-17">More Advanced Topics</a><ul>
<li><a class="reference internal" href="#metaprogramming" id="toc-entry-18">Metaprogramming</a></li>
<li><a class="reference internal" href="#improper-lists" id="toc-entry-19">Improper Lists</a></li>
<li><a class="reference internal" href="#opencl" id="toc-entry-20">OpenCL</a></li>
<li><a class="reference internal" href="#post-mortem-investigations" id="toc-entry-21">Post-Mortem Investigations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#language-bindings" id="toc-entry-22">Language Bindings</a></li>
<li><a class="reference internal" href="#language-implementation" id="toc-entry-23">Language Implementation</a><ul>
<li><a class="reference internal" href="#message-passing-copying-vs-sharing" id="toc-entry-24">Message-Passing: Copying vs Sharing</a></li>
<li><a class="reference internal" href="#just-in-time-compilation" id="toc-entry-25">Just-in-Time Compilation</a></li>
<li><a class="reference internal" href="#static-typing" id="toc-entry-26">Static Typing</a></li>
<li><a class="reference internal" href="#software-robustness" id="toc-entry-27">Software Robustness</a></li>
<li><a class="reference internal" href="#intermediate-languages" id="toc-entry-28">Intermediate Languages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#short-hints" id="toc-entry-29">Short Hints</a><ul>
<li><a class="reference internal" href="#dealing-with-conditional-availability" id="toc-entry-30">Dealing with Conditional Availability</a></li>
<li><a class="reference internal" href="#runtime-library-version" id="toc-entry-31">Runtime Library Version</a></li>
<li><a class="reference internal" href="#proper-naming" id="toc-entry-32">Proper Naming</a></li>
<li><a class="reference internal" href="#formatting-erlang-code" id="toc-entry-33">Formatting Erlang Code</a></li>
<li><a class="reference internal" href="#language-features" id="toc-entry-34">Language Features</a></li>
<li><a class="reference internal" href="#disabling-lco" id="toc-entry-35">Disabling LCO</a></li>
<li><a class="reference internal" href="#using-wx" id="toc-entry-36">Using wx</a></li>
<li><a class="reference internal" href="#installing-rebar3" id="toc-entry-37">Installing rebar3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#micro-cheat-sheet" id="toc-entry-38">Micro-Cheat Sheet</a></li>
<li><a class="reference internal" href="#erlang-resources" id="toc-entry-39">Erlang Resources</a></li>
</ul>
</div>
<p><span class="raw-html"></center></span></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#toc-entry-1">Overview</a></h1>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Erlang_(programming_language)">Erlang</a>  is a concurrent, functional programming language available as free software; see <a class="reference external" href="https://www.erlang.org/">its official website</a> for more details.</p>
<p>Erlang is dynamically typed, and is executed by the <a class="reference external" href="https://en.wikipedia.org/wiki/BEAM_(Erlang_virtual_machine)">BEAM virtual machine</a>. This VM (<em>Virtual Machine</em>) operates on bytecodes and can perform Just-In-Time compilation. It powers also <a class="reference external" href="https://github.com/llaisdy/beam_languages">other related languages</a>, such as Elixir and LFE.</p>
</div>
<div class="section" id="let-s-start-with-some-shameless-advertisement-for-erlang-and-the-beam-vm">
<h1><a class="toc-backref" href="#toc-entry-2">Let's Start with some Shameless Advertisement for Erlang and the BEAM VM</a></h1>
<p>Taken from <a class="reference external" href="https://erlangforums.com/t/erlang-101-processes-parallelization/594">this presentation</a>:</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p><em>What makes Elixir StackOverflow’s #4 most-loved language?</em></p>
<p><em>What makes Erlang and Elixir StackOverflow’s #3 and #4 best-paid languages?</em></p>
<p><em>How did WhatsApp scale to billions of users with just dozens of Erlang engineers?</em></p>
<p><em>What’s so special about Erlang that it powers CouchDB and RabbitMQ?</em></p>
<p><em>Why are multi-billion-dollar corporations like Bet365 and Klarna built on Erlang?</em></p>
<p><em>Why do PepsiCo, Cars.com, Change.org, Boston’s MBTA, and Discord all rely on Elixir?</em></p>
<p><em>Why was Elixir chosen to power a bank?</em></p>
<p class="last"><em>Why does Cisco ship 2 million Erlang devices each year? Why is Erlang used to control 90% of Internet traffic?</em></p>
</div>
</div>
<div class="section" id="installation">
<span id="erlang-installation"></span><h1><a class="toc-backref" href="#toc-entry-3">Installation</a></h1>
<p>Erlang can be installed thanks to the various options listed in <a class="reference external" href="https://www.erlang.org/downloads">these guidelines</a>.</p>
<p>Building Erlang from the sources of its latest stable version is certainly the best approach; for more control we prefer relying on our <a class="reference external" href="https://myriad.esperide.org/#software-prerequisites">custom procedure</a>.</p>
<p>For a development activity, we recommend also specifying the following options to our <tt class="docutils literal"><span class="pre">conf/install-erlang.sh</span></tt> script:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">--doc-install</span></tt>, so that the reference documentation can be accessed locally (in <tt class="docutils literal"><span class="pre">~/Software/Erlang/Erlang-current-documentation/</span></tt>); creating a bookmark pointing to the module index, located in <tt class="docutils literal">doc/man_index.html</tt>, would most probably be useful</li>
<li><tt class="docutils literal"><span class="pre">--generate-plt</span></tt> in order to generate a PLT file allowing the static type checking that applies to this installation (may be a bit long and processing-intensive, yet it is to be done once per built Erlang version)</li>
</ul>
<p>Run <tt class="docutils literal"><span class="pre">./install-erlang.sh</span> <span class="pre">--help</span></tt> for more information.</p>
<p>Once installed, ensure that <tt class="docutils literal"><span class="pre">~/Software/Erlang/Erlang-current-install/bin/</span></tt> is in your PATH (e.g. by enriching your <tt class="docutils literal"><span class="pre">~/.bashrc</span></tt> accordingly), so that you can run <tt class="docutils literal">erl</tt> (the Erlang interpreter) from any location, resulting a prompt like:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>erl<span class="w">
</span>Erlang/OTP<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">[</span>erts-12.1.5<span class="o">]</span><span class="w"> </span><span class="o">[</span>source<span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="m">64</span>-bit<span class="o">]</span><span class="w"> </span><span class="o">[</span>smp:8:8<span class="o">]</span><span class="w"> </span><span class="o">[</span>ds:8:8:10<span class="o">]</span><span class="w"> </span><span class="o">[</span>async-threads:1<span class="o">]</span><span class="w"> </span><span class="o">[</span>jit<span class="o">]</span><span class="w">

</span>Eshell<span class="w"> </span>V12.1.5<span class="w">  </span><span class="o">(</span>abort<span class="w"> </span>with<span class="w"> </span>^G<span class="o">)</span><span class="w">
</span><span class="m">1</span>&gt;
</pre>
<p>Then enter <tt class="docutils literal"><span class="pre">CTRL-C</span></tt> twice in order to come back to the (UNIX) shell.</p>
<p>Congratulations, you have a functional Erlang now!</p>
<p>To check from the command-line the version of an Erlang install:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>erl<span class="w"> </span>-eval<span class="w"> </span><span class="s1">'{ok, V} = file:read_file( filename:join([code:root_dir(), &quot;releases&quot;, erlang:system_info(otp_release), &quot;OTP_VERSION&quot;]) ), io:fwrite(V), halt().'</span><span class="w"> </span>-noshell<span class="w">
</span><span class="m">24</span>.2
</pre>
</div>
<div class="section" id="ceylan-s-language-use">
<h1><a class="toc-backref" href="#toc-entry-4">Ceylan's Language Use</a></h1>
<p>Ceylan users shall note that most of our related developments (namely <a class="reference external" href="http://myriad.esperide.org">Myriad</a>, <a class="reference external" href="http://wooper.esperide.org">WOOPER</a>, <a class="reference external" href="http://traces.esperide.org">Traces</a>, <a class="reference external" href="http://leec.esperide.org">LEEC</a>, <a class="reference external" href="http://seaplus.esperide.org">Seaplus</a>, <a class="reference external" href="http://mobile.esperide.org">Mobile</a>, <a class="reference external" href="http://us-common.esperide.org">US-Common</a>, <a class="reference external" href="http://us-web.esperide.org">US-Web</a> and <a class="reference external" href="http://us-main.esperide.org">US-Main</a>) depart significantly from the general conventions observed by most Erlang applications:</p>
<ul class="simple">
<li>notably because of their reliance on parse transforms, by default they rely on our own build system based on <a class="reference external" href="Build.html#gnu-make">GNU make</a> (rather than on <a class="reference external" href="https://www.rebar3.org/">rebar3</a>)</li>
<li>they tend not to rely on OTP abstractions such as <tt class="docutils literal">gen_server</tt>, as WOOPER offers OOP (<em>Object-Oriented Programming</em>) ones that we prefer</li>
</ul>
</div>
<div class="section" id="using-the-shell">
<h1><a class="toc-backref" href="#toc-entry-5">Using the Shell</a></h1>
<p>If it is as simple to run <tt class="docutils literal">erl</tt>, we prefer, with Ceylan settings, running <tt class="docutils literal">make shell</tt> in order to benefit from a well-initialized VM (notably with the full code path of the current layer and the ones below).</p>
<p>Refer then to the <a class="reference external" href="https://www.erlang.org/doc/man/shell.html#shell-commands">shell commands</a>, notably for:</p>
<ul class="simple">
<li><tt class="docutils literal">f/1</tt>, used as <tt class="docutils literal">f(X).</tt> in order to <em>forget</em> a variable <tt class="docutils literal">X</tt>, i.e. to remove the binding of this variable and be able to (re)assign it afterwards</li>
<li><tt class="docutils literal">l/1</tt> (apparently undocumented), used as <tt class="docutils literal">l(my_module)</tt>, to (re)load that module, purging any old version of it; convenient to reload also specially-built BEAMs (e.g. based on parse transforms) that may have been compiled behind the scene</li>
<li><tt class="docutils literal">rl/1</tt> is <em>not</em> &quot;reload (module)&quot; (use <tt class="docutils literal">l/1</tt> for that), it is &quot;record list&quot; (it prints selected record definitions)</li>
<li><tt class="docutils literal">c/1</tt>, used as <tt class="docutils literal">c(my_module)</tt>, to compile (if necessary) <em>and</em> (re)load that module, purging any old version of it</li>
<li><tt class="docutils literal"><span class="pre">rr/{1,2,3}</span></tt> (e.g. used as <tt class="docutils literal">rr(Path).</tt>) to <em>read records</em> and have them available on the shell; for example, to be able to use the records defined by xmerl:</li>
</ul>
<pre class="code erlang literal-block">
<span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rr</span><span class="p">(</span><span class="nn">code</span><span class="p">:</span><span class="nf">lib_dir</span><span class="p">(</span><span class="n">xmerl</span><span class="p">)</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;/include/xmerl.hrl&quot;</span><span class="p">).</span>
</pre>
<p>See also the <a class="reference external" href="https://www.erlang.org/doc/man/shell.html#jcl-mode">JCL mode</a> (for <em>Job Control Language</em>) to connect and interact with other Erlang nodes.</p>
</div>
<div class="section" id="about-security">
<h1><a class="toc-backref" href="#toc-entry-6">About Security</a></h1>
<ul class="simple">
<li>one should not encrypt messages directly with a key pair (e.g. with RSA, only messages up to around 200 bytes long can be encrypted):  one should encrypt only a <em>symmetric key</em> (generated by a cryptographically-safe random algorithm) that is then used to encrypt one's message(s); ensure an Encrypt-Then-Authenticate scheme to prevent padding oracle attacks (and a secure-compare algorithm for the <em>Message Authentication Code</em> verification to prevent timing attacks); using <a class="reference external" href="https://doc.libsodium.org/">libsodium</a> should make mistakes using the standard crypto primitives less error-prone; see the <a class="reference external" href="https://github.com/jlouis/enacl">enacl</a> Erlang binding for that; for more information, refer to <a class="reference external" href="https://erlangforums.com/t/cannot-encrypt-a-long-binary-using-public-key-encrypt-private-2/724">the corresponding thread</a></li>
<li>relevant sources of information:<ul>
<li>books:<ul>
<li><tt class="docutils literal">Cryptography Engineering: Design Principles and Practical Applications</tt></li>
<li><tt class="docutils literal">Practical Cryptography</tt></li>
</ul>
</li>
<li>the <a class="reference external" href="https://erlef.github.io/security-wg/secure_coding_and_deployment_hardening/">Security Working Group</a> of the EEF (<em>Erlang Ecosystem Foundation</em>)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="otp-guidelines">
<h1><a class="toc-backref" href="#toc-entry-7">OTP Guidelines</a></h1>
<div class="section" id="the-app-specification">
<h2><a class="toc-backref" href="#toc-entry-8">The <tt class="docutils literal">.app</tt> Specification</a></h2>
<p>For an overall application named <tt class="docutils literal">Foobar</tt>, we recommend defining in <tt class="docutils literal">conf/foobar.app.src</tt> an application specification template that, once properly filled regarding the version of  that application and the modules that it comprises (possibly automatically done thanks to the <a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> logic), will result in an actual application specification file, <tt class="docutils literal">foobar.app</tt>.</p>
<p>Such a file is necessary in all cases, to generate an OTP application (otherwise with <a class="reference external" href="http://rebar3.org/">rebar3</a> nothing will be built), an OTP release (otherwise the application dependencies will not be reachable), and probably an <a class="reference external" href="https://hex.pm/">hex</a> package as well.</p>
<p>This specification content is to end up in various places:</p>
<ul class="simple">
<li>in <tt class="docutils literal">ebin/foobar.app</tt></li>
<li>if using rebar3, in the OTP build tree (by default: <tt class="docutils literal">./_build/lib/foobar/ebin/foobar.app</tt>)</li>
<li>with <tt class="docutils literal">src/foobar.app.src</tt> being a symbolic link pointing to <tt class="docutils literal">ebin/foobar.app</tt> (probably at least for hex)</li>
</ul>
</div>
<div class="section" id="starting-otp-applications">
<h2><a class="toc-backref" href="#toc-entry-9">Starting OTP Applications</a></h2>
<p>For an OTP <em>active</em> application of interest - that is one that provides an actual service, i.e. running processes, as opposed to a mere <em>library</em> application, which provides only code - such a specification defines, among other elements, which module will be used to start this application. We recommend to name this module according to the target application and to suffix it with <tt class="docutils literal">_app</tt>, like in:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="n">application</span><span class="p">,</span><span class="w"> </span><span class="n">foobar</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[...]</span><span class="w">
    </span><span class="p">{</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">foobar_app</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">hello</span><span class="p">]}},</span><span class="w">
    </span><span class="p">[...]</span>
</pre>
<p>This implies that once a user code will call <tt class="docutils literal">application:start(foobar)</tt>, then <tt class="docutils literal">foobar_app:start(_Type=normal, <span class="pre">_Args=[hello])</span></tt> will be called in turn.</p>
<p>This <tt class="docutils literal">start/2</tt> function, together with its <tt class="docutils literal">stop/1</tt> reciprocal, are the functions listed by the OTP (active) <tt class="docutils literal">application</tt> behaviour; at least for clarity, it is better that <tt class="docutils literal">foobar_app.erl</tt> comprises <tt class="docutils literal"><span class="pre">-behaviour(application).</span></tt></p>
</div>
<div class="section" id="pre-launch-functions">
<h2><a class="toc-backref" href="#toc-entry-10">Pre-Launch Functions</a></h2>
<p>The previous OTP callbacks may be called by specific-purpose launching code; we tend to define an <tt class="docutils literal">exec/0</tt> function for that: then, with the Myriad make system, executing on the command-line <tt class="docutils literal">make foobar_exec</tt> results in <tt class="docutils literal">foobar_app:exec/0</tt> to be called.</p>
<p>Having such a pre-launch function is useful when having to set specific information beforehand (see <tt class="docutils literal"><span class="pre">application:set_env/{1,2}</span></tt>) and/or when starting by oneself applications (e.g. see <tt class="docutils literal">otp_utils:start_applications/2</tt>).</p>
<p>In any case this should result in <tt class="docutils literal">foobar_app:start/2</tt> to be called at application startup, a function whose purpose is generally to spawn the root supervisor of this application.</p>
<p>Note that, alternatively (perhaps for some uncommon debugging needs), one may execute one's application (e.g. <tt class="docutils literal">foo</tt>) by oneself, knowing that doing so requires starting beforehand the applications it depends on - be them Erlang-standard (e.g. <tt class="docutils literal">kernel, stdlib</tt>) or user-provided (e.g. <tt class="docutils literal">bar, buz</tt>); for that both their modules <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[3]</a> and their <tt class="docutils literal">.app</tt> file <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[4]</a> must be found.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[3]</a></td><td>If using Ceylan-Myriad, run, from the root of <tt class="docutils literal">foo</tt>, <tt class="docutils literal">make <span class="pre">copy-all-beams-to-ebins</span></tt> to populate the <tt class="docutils literal">ebin</tt> directories of all layers (knowing that by default each module is only to be found directly from its source/build directory, and thus such a copy is usually unnecessary).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[4]</a></td><td>If using Ceylan-Myriad, run, from the root of <tt class="docutils literal">foo</tt>, <tt class="docutils literal">make <span class="pre">create-app-file</span></tt>.</td></tr>
</tbody>
</table>
<p>This can be done with:</p>
<pre class="code erlang literal-block">
<span class="sc">$ </span><span class="n">erl</span><span class="w"> </span><span class="o">-</span><span class="n">pa</span><span class="w"> </span><span class="nv">XXX</span><span class="o">/</span><span class="n">bar</span><span class="o">/</span><span class="n">ebin</span><span class="w"> </span><span class="o">-</span><span class="n">pa</span><span class="w"> </span><span class="nv">YYY</span><span class="o">/</span><span class="n">buz</span><span class="o">/</span><span class="n">ebin</span><span class="w"> </span><span class="o">-</span><span class="n">pa</span><span class="w"> </span><span class="nv">ZZZ</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">ebin</span><span class="w">

</span><span class="nv">Erlang</span><span class="o">/</span><span class="nv">OTP</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="p">[</span><span class="n">erts</span><span class="o">-</span><span class="mi">14</span><span class="p">.</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nn">smp</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nn">ds</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">async</span><span class="o">-</span><span class="nn">threads</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nn">jit</span><span class="p">:</span><span class="n">ns</span><span class="p">]</span><span class="w">

</span><span class="nv">Eshell</span><span class="w"> </span><span class="nv">V14</span><span class="p">.</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">press</span><span class="w"> </span><span class="nv">Ctrl</span><span class="o">+</span><span class="nv">G</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">abort</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">help</span><span class="p">().</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">help</span><span class="p">)</span><span class="w">
</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nn">application</span><span class="p">:</span><span class="nf">ensure_all_started</span><span class="p">([</span><span class="n">kernel</span><span class="p">,</span><span class="w"> </span><span class="n">stdlib</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">buz</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">]).</span>
</pre>
<p>Then the <tt class="docutils literal">foo</tt> application shall be launched, and a shell be available to interact with the corresponding VM.</p>
</div>
<div class="section" id="otp-supervisors">
<h2><a class="toc-backref" href="#toc-entry-11">OTP Supervisors</a></h2>
<p>The purpose of supervisors is to ease the development of fault-tolerant applications by building hierarchical process structures called <em>supervision trees</em>.</p>
<p>For that, supervisors are to monitor their children, that may be workers (typically implementing the <tt class="docutils literal">gen_{event,server,statem}</tt> behaviour) and/or other supervisors (they can thus be nested).</p>
<p>We recommend to define a <tt class="docutils literal">foobar_sup:start_link/0</tt> function (it is an user-level API, so any name and arity can be used). This <tt class="docutils literal">foobar_sup</tt> module is meant to implement the <tt class="docutils literal">supervisor</tt> behaviour (to be declared with <tt class="docutils literal"><span class="pre">-behaviour(supervisor).</span></tt>), which in practice requires an <tt class="docutils literal">init/1</tt> function to be defined.</p>
<p>So this results, in <tt class="docutils literal">foobar_sup</tt>, in a code akin to:</p>
<pre class="code erlang literal-block">
<span class="p">-</span><span class="ni">spec</span><span class="w"> </span><span class="n">start_link</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">supervisor</span><span class="p">:</span><span class="nf">startlink_ret</span><span class="p">().</span><span class="w">
</span><span class="nf">start_link</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="c">% This will result in calling init/1 next:</span><span class="w">
   </span><span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="w"> </span><span class="p">_</span><span class="nv">Registration</span><span class="o">=</span><span class="p">{</span><span class="n">local</span><span class="p">,</span><span class="w"> </span><span class="n">my_foobar_main_sup</span><span class="p">},</span><span class="w">
                          </span><span class="p">_</span><span class="nv">Mod</span><span class="o">=?</span><span class="nv">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Args</span><span class="o">=</span><span class="p">[]).</span><span class="w">

</span><span class="p">-</span><span class="ni">spec</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="n">list</span><span class="p">())</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="n">'ok'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nn">supervisor</span><span class="p">:</span><span class="nf">sup_flags</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="n">child_spec</span><span class="p">()]}}.</span><span class="w">
</span><span class="nf">init</span><span class="p">(_</span><span class="nv">Args</span><span class="o">=</span><span class="p">[])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="p">[...]</span><span class="w">
   </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">SupSettings</span><span class="p">,</span><span class="w"> </span><span class="nv">ChildSpecs</span><span class="p">}}.</span>
</pre>
</div>
<div class="section" id="declaring-worker-processes">
<h2><a class="toc-backref" href="#toc-entry-12">Declaring Worker Processes</a></h2>
<p>Our <tt class="docutils literal">otp_utils</tt> module may help a bit defining proper restart strategies and child specifications, i.e. the information regarding the workers that will be supervised, here, by this root supervisor.</p>
<p>For example it could be:</p>
<pre class="code erlang literal-block">
<span class="nf">init</span><span class="p">(_</span><span class="nv">Args</span><span class="o">=</span><span class="p">[])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="p">[...]</span><span class="w">
   </span><span class="nv">SupSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">otp_utils</span><span class="p">:</span><span class="nf">get_supervisor_settings</span><span class="p">(</span><span class="w">
                   </span><span class="p">_</span><span class="nv">RestartStrategy</span><span class="o">=</span><span class="n">one_for_one</span><span class="p">,</span><span class="w"> </span><span class="nv">ExecTarget</span><span class="p">),</span><span class="w">
   </span><span class="c">% Always restarted in production:</span><span class="w">
   </span><span class="nv">RestartSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">otp_utils</span><span class="p">:</span><span class="nf">get_restart_setting</span><span class="p">(</span><span class="nv">ExecTarget</span><span class="p">),</span><span class="w">
   </span><span class="nv">WorkerShutdownDuration</span><span class="w"> </span><span class="o">=</span><span class="w">
       </span><span class="nn">otp_utils</span><span class="p">:</span><span class="nf">get_maximum_shutdown_duration</span><span class="p">(</span><span class="nv">ExecTarget</span><span class="p">),</span><span class="w">
   </span><span class="c">% First child, the main Foobar worker process:</span><span class="w">
   </span><span class="nv">MainWorkerChild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">#{</span><span class="w">
       </span><span class="n">id</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">foobar_main_worker_id</span><span class="p">,</span><span class="w">
       </span><span class="n">start</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{_</span><span class="nv">Mod</span><span class="o">=</span><span class="n">foobar</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Fun</span><span class="o">=</span><span class="n">start_link</span><span class="p">,</span><span class="w">
                 </span><span class="p">_</span><span class="nv">MainWorkerArgs</span><span class="o">=</span><span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="w"> </span><span class="nv">B</span><span class="p">,</span><span class="w"> </span><span class="nv">C</span><span class="p">]},</span><span class="w">
       </span><span class="n">restart</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">RestartSettings</span><span class="p">,</span><span class="w">
       </span><span class="n">shutdown</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nv">WorkerShutdownDuration</span><span class="p">,</span><span class="w">
       </span><span class="n">type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">worker</span><span class="p">,</span><span class="w">
       </span><span class="n">modules</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">foobar</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
   </span><span class="nv">ChildSpecs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">MainWorkerChild</span><span class="p">],</span><span class="w">
   </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">SupSettings</span><span class="p">,</span><span class="w"> </span><span class="nv">ChildSpecs</span><span class="p">}}.</span>
</pre>
<p>Children are created synchronously and in the order of their specification <a class="footnote-reference" href="#footnote-3" id="footnote-reference-3">[5]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[5]</a></td><td>Yet some interleaving is possible thanks to <tt class="docutils literal">proc_lib:init_ack/1</tt>.</td></tr>
</tbody>
</table>
<p>So if <tt class="docutils literal"><span class="pre">ChildSpecs=[A,</span> B, C]</tt>, then a child according to the A spec is first created, then, once it is over (either its <tt class="docutils literal">init/1</tt> finished successfully, or it called <tt class="docutils literal"><span class="pre">proc_lib:init_ack/{1,2}</span></tt> <a class="footnote-reference" href="#footnote-4" id="footnote-reference-4">[6]</a> and then continued its own initialisation concurrently), a child according to the B spec is created, then once done a child according to the C spec.</p>
<table class="docutils footnote" frame="void" id="footnote-4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-4">[6]</a></td><td>Typically: <tt class="docutils literal"><span class="pre">proc_lib:init_ack(self())</span></tt>.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="implementing-worker-processes">
<h2><a class="toc-backref" href="#toc-entry-13">Implementing Worker Processes</a></h2>
<p>Such a worker, which can be any Erlang process (implementing an OTP behaviour, like <tt class="docutils literal">gen_server</tt>, or not) will thus be spawned here through a call to the <tt class="docutils literal">foobar:start_link/3</tt> function (another user-defined API) made by this supervisor. This is a mere <em>call</em> (an <tt class="docutils literal">apply/3</tt>), not a spawn of a child process based on that function.</p>
<p>Therefore the called function is expected to <em>create</em> the worker process by itself, like, in the <tt class="docutils literal">foobar</tt> module:</p>
<pre class="code erlang literal-block">
<span class="nf">start_link</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="w"> </span><span class="nv">B</span><span class="w"> </span><span class="p">,</span><span class="nv">C</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="p">[...]</span><span class="w">
   </span><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="nn">proc_lib</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">Func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span><span class="w">
       </span><span class="p">_</span><span class="nv">Args</span><span class="o">=</span><span class="p">[</span><span class="nv">U</span><span class="p">,</span><span class="w"> </span><span class="nv">V</span><span class="p">],</span><span class="w"> </span><span class="p">_</span><span class="nv">Timeout</span><span class="o">=</span><span class="n">infinity</span><span class="p">,</span><span class="w"> </span><span class="nv">SpawnOpts</span><span class="p">)}.</span>
</pre>
<p>Here thus the spawned worker will start by executing <tt class="docutils literal">foobar:init/2</tt>, a function not expected to return, often trapping EXIT signals (<tt class="docutils literal">process_flag(trap_exit, true)</tt>), setting system flags and, once properly initialised, notifying its supervisor that it is up and running (e.g. <tt class="docutils literal"><span class="pre">proc_lib:init_ack(_Return=self())</span></tt>) before usually entering a tail-recursive loop.</p>
</div>
<div class="section" id="terminating-workers">
<h2><a class="toc-backref" href="#toc-entry-14">Terminating Workers</a></h2>
<p>Depending on the <tt class="docutils literal">shutdown</tt> entry of its child specification, on application stop that worker may be terminated by different ways. We tend to prefer specifying a maximum shutdown duration: then the worker will be sent by its supervisor first a <tt class="docutils literal">shutdown</tt> EXIT message, that this worker may handle, typically in its main loop:</p>
<pre class="code erlang literal-block">
<span class="k">receive</span><span class="w">
   </span><span class="p">[...]</span><span class="w">

   </span><span class="p">{</span><span class="n">'EXIT'</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="nv">SupervisorPid</span><span class="p">,</span><span class="w"> </span><span class="n">shutdown</span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="c">% Just stop.</span><span class="w">
      </span><span class="p">[...]</span>
</pre>
<p>If the worker fails to stop (on time, or at all) and properly terminate, it will then be brutally killed by its supervisor.</p>
</div>
<div class="section" id="supervisor-bridges">
<h2><a class="toc-backref" href="#toc-entry-15">Supervisor Bridges</a></h2>
<p>Non-OTP processes (e.g. <a class="reference external" href="http://wooper.esperide.org">WOOPER</a> instances) can act as supervisors thanks to the <a class="reference external" href="https://www.erlang.org/doc/man/supervisor_bridge.html">supervisor_bridge</a> module.</p>
<p>Such a process shall implement the <tt class="docutils literal">supervisor_bridge</tt> behaviour, namely <tt class="docutils literal">init/1</tt> and <tt class="docutils literal">terminate/2</tt>. If the former function spawns a process, the latter shall ensure that this process terminates in a synchronous manner, otherwise race conditions may happen.</p>
<p>See <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces/blob/master/src/traces_bridge_sup.erl">traces_bridge_sup</a> for an example thereof.</p>
</div>
<div class="section" id="extra-information">
<h2><a class="toc-backref" href="#toc-entry-16">Extra Information</a></h2>
<p>One may refer to;</p>
<ul class="simple">
<li><a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> as an example of OTP <em>Library</em> Application</li>
<li><a class="reference external" href="http://wooper.esperide.org">Ceylan-WOOPER</a> or <a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> as examples of OTP <em>Active</em> Applications</li>
<li><a class="reference external" href="http://us-web.esperide.org">US-Web</a> as an example of most of these supervisor principles</li>
</ul>
</div>
</div>
<div class="section" id="more-advanced-topics">
<h1><a class="toc-backref" href="#toc-entry-17">More Advanced Topics</a></h1>
<div class="section" id="metaprogramming">
<h2><a class="toc-backref" href="#toc-entry-18">Metaprogramming</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Metaprogramming">Metaprogramming</a> is to be done in Erlang through <strong>parse transforms</strong>, which are user-defined modules that transform an AST (for <em>Abstract Syntax Trees</em>, an Erlang term that represents actual code; see the <a class="reference external" href="https://www.erlang.org/doc/apps/erts/absform.html">Abstract Format</a> for more details) into another AST that is fed afterwards to the compiler.</p>
<p>See also:</p>
<ul class="simple">
<li>this <a class="reference external" href="https://chlorophil.blogspot.com/2007/04/erlang-macro-processor-v1-part-i.html">introduction to parse transforms</a></li>
<li>Ceylan-Myriad's <a class="reference external" href="https://myriad.esperide.org/#support-for-metaprogramming">support for metaprogramming</a></li>
</ul>
</div>
<div class="section" id="improper-lists">
<h2><a class="toc-backref" href="#toc-entry-19">Improper Lists</a></h2>
<p>A proper list is created from the empty one (<tt class="docutils literal">[]</tt>, also known as &quot;nil&quot;) by appending (with the <tt class="docutils literal">|</tt> operator, a.k.a. &quot;cons&quot;) elements in turn; for example <tt class="docutils literal">[1,2]</tt> is actually <tt class="docutils literal">[1 | [2 | <span class="pre">[]]]</span></tt>.</p>
<p>However, instead of enriching a list from the empty one, one <em>can</em> start a list with any other term than <tt class="docutils literal">[]</tt>, for example <tt class="docutils literal">my_atom</tt>. Then, instead of <tt class="docutils literal"><span class="pre">[2|[]]</span></tt>, <tt class="docutils literal">[2|my_atom]</tt> may be specified and will be indeed a list - albeit an improper one.</p>
<p>Many recursive functions expect proper lists, and will fail (typically with a function clause) if given an improper list to process (e.g. <tt class="docutils literal">lists:flatten/1</tt>).</p>
<p>So, why not banning such construct? Why even standard modules like <tt class="docutils literal">digraph</tt> rely on improper lists?</p>
<p>The reason is that improper lists are a way to reduce the memory footprint of some datastructures, by storing a value of interest instead of the empty list.</p>
<p>Indeed, as explained <a class="reference external" href="https://groups.google.com/g/erlang-programming/c/mQLS5yGX_8g/m/Ad4VVyOUDQAJ">in this post</a>, a (proper) list of 2 elements will consume:</p>
<ul class="simple">
<li>1 list cell (2 words of memory) to store the first element and a pointer to second cell</li>
<li>1 list cell (2 more words) to store the second element and the empty list</li>
</ul>
<p>For a total of 4 words of memory (so, on a 64-bit architecture, it is 32 bytes).</p>
<p>As for an improper list of 2 elements, only 1 list cell (2 words of memory) will be consumed to store the first element and then the second one.</p>
<p>Such a solution is even more compact than a pair (a 2-element tuple), which consumes 2+1 = 3 words. Accessing the elements of an improper list is also faster (one handle to be inspected vs also an header to be inspected).</p>
<p>Finally, for sizes expressed in bytes:</p>
<pre class="code erlang literal-block">
<span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="nn">system_utils</span><span class="p">:</span><span class="nf">get_size</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="n">my_atom</span><span class="p">]).</span><span class="w">
</span><span class="mi">40</span><span class="w">

</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="nn">system_utils</span><span class="p">:</span><span class="nf">get_size</span><span class="p">({</span><span class="mi">2</span><span class="p">,</span><span class="n">my_atom</span><span class="p">}).</span><span class="w">
</span><span class="mi">32</span><span class="w">

</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="nn">system_utils</span><span class="p">:</span><span class="nf">get_size</span><span class="p">([</span><span class="mi">2</span><span class="p">|</span><span class="n">my_atom</span><span class="p">]).</span><span class="w">
</span><span class="mi">24</span>
</pre>
<p>See also the <a class="reference external" href="http://beam-wisdoms.clau.se/en/latest/indepth-memory-layout.html#lists-cons">1</a>, <a class="reference external" href="http://beam-wisdoms.clau.se/en/latest/indepth-data-sizes.html#list">2</a> pointers for more information.</p>
<p>Everyone shall decide on whether relying on improper lists is a trick, a hack or a technique to prohibit.</p>
</div>
<div class="section" id="opencl">
<h2><a class="toc-backref" href="#toc-entry-20">OpenCL</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/OpenCL">Open Computing Language</a> is a standard interface designed to program many processing architectures, such as CPUs, GPUs, DSPs, FPGAs.</p>
<p>OpenCL is notably a way of using one's GPU to perform more general-purpose processing than typically the rendering operations allowed by <a class="reference external" href="ThreeDimensional.html#glsl">GLSL</a> (even compared to its compute shaders).</p>
<p>In Erlang, the <a class="reference external" href="https://github.com/tonyrog/cl">cl binding</a> is available for that.</p>
<p>A notable user thereof is <a class="reference external" href="ThreeDimensional.html#wings3d">Wing3D</a>; one may refer to the <tt class="docutils literal">*.cl</tt> files in <a class="reference external" href="https://github.com/dgud/wings/tree/master/shaders">this directory</a>, but also to its optional build integration as a source of inspiration, and to <a class="reference external" href="https://github.com/dgud/wings/blob/master/src/wings_cl.erl">wings_cl.erl</a>.</p>
</div>
<div class="section" id="post-mortem-investigations">
<h2><a class="toc-backref" href="#toc-entry-21">Post-Mortem Investigations</a></h2>
<p>Erlang programs may fail, and this may result in mere (Erlang-level) crashes (the VM detects an error, and reports information about it, possibly in the form of a crash dump) or (sometimes, quite infrequently though) in more brutal, lower-level core dumps (the VM crashes as a whole, like any faulty program run by the operating system); this last case happens typically when relying on faulty <a class="reference external" href="https://www.erlang.org/doc/tutorial/nif.html">NIFs</a>.</p>
<div class="section" id="erlang-crash-dumps">
<h3>Erlang Crash Dumps</h3>
<p>If experiencing &quot;only&quot; an Erlang-level crash, a <tt class="docutils literal">erl_crash.dump</tt> file is produced in the directory whence the executable (generally <tt class="docutils literal">erl</tt>) was launched. The best way to study it is to use the <tt class="docutils literal">cdv</tt> (refer to <a class="reference external" href="https://www.erlang.org/doc/apps/observer/crashdump_ug.html">crashdump viewer</a>) tool, available, from the Erlang installation, as <tt class="docutils literal">lib/erlang/cdv</tt> <a class="footnote-reference" href="#footnote-5" id="footnote-reference-5">[7]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-5">[7]</a></td><td>Hence, according to the Ceylan-Myriad conventions, in <tt class="docutils literal"><span class="pre">~/Software/Erlang/Erlang-current-install/lib/erlang/cdv</span></tt>.</td></tr>
</tbody>
</table>
<p>Using this debug tool is as easy as:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>cdv<span class="w"> </span>erl_crash.dump
</pre>
<p>Then, through the wx-based interface, a rather large number of Erlang-level information will be available (processes, ports, ETS tables, nodes, modules, memory, etc.) to better understand the context of this crash and hopefully diagnose its root cause.</p>
</div>
<div class="section" id="core-dumps">
<h3>Core Dumps</h3>
<p>In the worst cases, the VM will crash like any other OS-level process, and generic (non Erlang-specific) tools will have to be used. Do not expect to be pointed to line numbers in Erlang source files anymore!</p>
<p>Refer to our general section dedicated to <a class="reference external" href="GNULinux.html#core-dumps">core dumps</a> for that.</p>
</div>
</div>
</div>
<div class="section" id="language-bindings">
<h1><a class="toc-backref" href="#toc-entry-22">Language Bindings</a></h1>
<p>The two main approaches in order to integrate third-party code to Erlang are to:</p>
<ul class="simple">
<li>interact with it as if it was another Erlang node; we defined <a class="reference external" href="http://seaplus.esperide.org">Ceylan-Seaplus</a> for that purpose, to simplify the binding of C code; other libraries provide link to various languages</li>
</ul>
<ul class="simple" id="nif">
<li>directly link the current Erlang VM to this code, through <a class="reference external" href="https://www.erlang.org/doc/tutorial/nif.html">NIF</a>; for C, it can be done manually, or may be automatised thanks to <a class="reference external" href="https://github.com/parapluu/nifty">nifty</a>, which is an <em>Erlang NIF Wrapper Generator</em>; this can be especially useful for larger APIs (e.g. <a class="reference external" href="https://www.libsdl.org/">SDL</a>); see also <a class="reference external" href="https://docs.rs/rustler/latest/rustler/pub">rusterl</a>, which allows to write NIFs in safe Rust code</li>
</ul>
</div>
<div class="section" id="language-implementation">
<h1><a class="toc-backref" href="#toc-entry-23">Language Implementation</a></h1>
<div class="section" id="message-passing-copying-vs-sharing">
<h2><a class="toc-backref" href="#toc-entry-24">Message-Passing: Copying vs Sharing</a></h2>
<p>Knowing that, in functional languages such as Erlang, terms (&quot;variables&quot;) are immutable, why could not they be shared between local processes when sent through messages, instead of being copied in the heap of each of them, as it is actually the case with the Erlang VM?</p>
<p>The reason lies in the fact that, beyond the constness of these terms, their life-cycle has also to be managed. If they are copied, each process can very easily perform its (concurrent, autonomous) garbage collections. On the contrary, if terms were shared, then reference counting would be needed to deallocate them properly (neither too soon nor never at all), which, in a concurrent context, is bound to require locks.</p>
<p>So a trade-off between memory (due to data duplication) and processing (due to lock contention) has to be found and at least for most terms (excepted larger binaries), the sweet spot consists in sacrificing a bit of memory in favour of a lesser CPU load. Solutions like <a class="reference external" href="https://www.erlang.org/doc/man/persistent_term.html">persistent_term</a> may address situations where more specific needs arise.</p>
</div>
<div class="section" id="just-in-time-compilation">
<span id="jit"></span><h2><a class="toc-backref" href="#toc-entry-25">Just-in-Time Compilation</a></h2>
<p>This long-awaited feature, named <em>BeamAsm</em> and whose rationale and history have been detailed in <a class="reference external" href="https://www.erlang.org/blog/the-road-to-the-jit/">these articles</a>, has been introduced in Erlang 24 and shall transparently lead to increased performances for most applications.</p>
</div>
<div class="section" id="static-typing">
<h2><a class="toc-backref" href="#toc-entry-26">Static Typing</a></h2>
<p>Static type checking can be performed on Erlang code; the usual course of action is to use <a class="reference external" href="https://www.erlang.org/doc/man/dialyzer.html">Dialyzer</a> - albeit other solutions like <a class="reference external" href="https://github.com/josefs/Gradualizer">Gradualizer</a> and also <a class="reference external" href="https://github.com/WhatsApp/eqwalizer">eqWAlizer</a> exist, and are mostly complementary (see also <a class="reference external" href="https://learnyousomeerlang.com/types-or-lack-thereof#for-type-junkies">1</a> and <a class="reference external" href="https://learnyousomeerlang.com/dialyzer">2</a>).</p>
<p>More precisely:</p>
<ul class="simple">
<li>Dialyzer is a discrepancy analyzer that aims <strong>to prove the presence of type-induced runtime crashes</strong> (it may not be able to detect all type problems, yet &quot;is never wrong&quot;); Dialyzer does not use type specifications to guide the analysis: first it infers type information, and then only, if requested, it checks that information against the type specifications; so Dialyzer may operate with or without type specifications</li>
<li>whereas tools like Gradualizer and eqWAlizer are more conventional type systems, based on the theory of gradual typing, that aim <strong>to prove the absence of such crashes</strong>; notably Gradualizer depends intimately on type specifications: by default, without them, no static typing happens</li>
</ul>
<p>See <a class="reference external" href="https://www.erlang.org/eeps/eep-0061">EEP 61</a> for further typing-related information <a class="footnote-reference" href="#footnote-6" id="footnote-reference-6">[8]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-6">[8]</a></td><td>On a side note, the (newer) <tt class="docutils literal">dynamic()</tt> type mentioned there is often used to mark &quot;inherently dynamic code&quot;, like reading from ETS, message passing, deserialization and so on.</td></tr>
</tbody>
</table>
<p>Also a few <a class="reference external" href="https://github.com/llaisdy/beam_languages#statically-typed-languages">statically-typed languages</a> can operate on top of the Erlang VM, even if none has reached yet the popularity of Erlang or Elixir (that are dynamically-typed).</p>
<p>In addition to the increased type safety that statically-typed languages permit (possibly applying to sequential code but also to inter-process messages), it is unsure whether such extra static awareness may also lead to better performances (especially now that the standard compiler supports <a class="reference internal" href="#jit">JIT</a>).</p>
<p>Beyond mere code, the messages exchanges between processes could also be typed and checked. Version upgrades could also benefit from it. Of course type-related errors are only a subset of the software errors.</p>
<p>Note that developments that rely on parse-transforms (almost all ours, directly or not) shall be verified based on their BEAM files (hence their actual, final output) rather than on their sources (as the checking would be done on code not transformed yet). See also the <a class="reference external" href="https://myriad.esperide.org/#type-checking-myriad">Type-checking Myriad</a> section.</p>
<div class="section" id="about-dialyzer">
<h3>About Dialyzer</h3>
<div class="section" id="installing-dialyzer">
<h4>Installing Dialyzer</h4>
<p>Nothing is to be done, as Dialyzer is included in the standard Erlang distribution.</p>
</div>
<div class="section" id="using-dialyzer">
<h4>Using Dialyzer</h4>
<p>Our preferred options (beyond path specifications of course) are: <tt class="docutils literal"><span class="pre">-Wextra_return</span> <span class="pre">-Wmissing_return</span> <span class="pre">-Wno_return</span> <span class="pre">-Werror_handling</span> <span class="pre">-Wno_improper_lists</span> <span class="pre">-Wno_unused</span> <span class="pre">-Wunderspecs</span></tt>. See the <tt class="docutils literal">DIALYZER_OPTS</tt> variable in Myriad's <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/GNUmakevars.inc">GNUmakevars.inc</a> and the copiously commented options.</p>
<p>A problem is that typing errors tend to snowball: many false positives (functions that are correct but whose call is not because an error upward in the callgraph) may be reported (leading to the infamous <tt class="docutils literal">Function f/N has no local return</tt>, which does not tell much).</p>
<p>We recommend focusing on the first error reported for each module, and re-running the static analysis once supposedly fixed.</p>
</div>
</div>
<div class="section" id="about-gradualizer">
<h3>About Gradualizer</h3>
<div class="section" id="installing-gradualizer">
<h4>Installing Gradualizer</h4>
<p>We install <a class="reference external" href="https://github.com/josefs/Gradualizer">Gradualizer</a> that way:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/Software<span class="w">
</span>$<span class="w"> </span>mkdir<span class="w"> </span>gradualizer<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>gradualizer<span class="w">
</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/josefs/Gradualizer.git<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>Gradualizer<span class="w">
</span>$<span class="w"> </span>make<span class="w"> </span>escript
</pre>
<p>Then just ensure that the <tt class="docutils literal">~/Software/gradualizer/Gradualizer/bin</tt> directory is in your PATH (e.g. set in your <tt class="docutils literal">.bashrc</tt>).</p>
</div>
<div class="section" id="using-gradualizer">
<h4>Using Gradualizer</h4>
<p>Our preferred options (beyond path specifications of course) are: <tt class="docutils literal"><span class="pre">--infer</span> <span class="pre">--fmt_location</span> verbose <span class="pre">--fancy</span> <span class="pre">--color</span> always <span class="pre">--stop_on_first_error</span></tt>. See the <tt class="docutils literal">GRADUALIZER_OPTS</tt> variable in Myriad's <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/GNUmakevars.inc">GNUmakevars.inc</a> and the copiously commented options..</p>
</div>
</div>
<div class="section" id="about-eqwalizer">
<h3>About eqWAlizer</h3>
<p>It is a tool developed in Rust.</p>
<div class="section" id="installing-eqwalizer">
<h4>Installing eqWAlizer</h4>
<p>We install <a class="reference external" href="https://github.com/WhatsApp/eqwalizer">eqWAlizer</a> that way:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/Software<span class="w">
</span>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>eqwalizer<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>eqwalizer<span class="w">
</span>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/WhatsApp/eqwalizer/releases/download/vx.y.z/elp-linux.tar.gz<span class="w">
</span>$<span class="w"> </span>tar<span class="w"> </span>xvf<span class="w"> </span>elp-linux.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>bin<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>/bin/mv<span class="w"> </span>-f<span class="w"> </span>elp<span class="w"> </span>bin/
</pre>
<p>Then just ensure that the <tt class="docutils literal">~/Software/eqwalizer/bin</tt> directory is in your PATH (e.g. set in your <tt class="docutils literal">.bashrc</tt>).</p>
</div>
<div class="section" id="using-eqwalizer">
<h4>Using eqWAlizer</h4>
<p>We use it out of a rebar3 context.</p>
<p>Settings are to be stored in a JSON file (e.g. <tt class="docutils literal"><span class="pre">conf/foobar-for-eqwalizer.json</span></tt>), to be designated thanks to the <tt class="docutils literal"><span class="pre">--project</span></tt> option.</p>
<p>See also the <tt class="docutils literal">EQWALIZER_OPTS</tt> variable in Myriad's <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/GNUmakevars.inc">GNUmakevars.inc</a> and its own <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/conf/myriad-for-eqwalizer.json">myriad-for-eqwalizer.json</a>  project file.</p>
<p>(our first test was not successful, we will have to investigate more when time permits)</p>
</div>
</div>
</div>
<div class="section" id="software-robustness">
<h2><a class="toc-backref" href="#toc-entry-27">Software Robustness</a></h2>
<p>Type correctness is essential, yet of course it does not guarantee that a program is correct and relevant. Other approaches, like the <strong>checking</strong> of other properties (notably concurrency, see <a class="reference external" href="https://github.com/parapluu/Concuerror">Concuerror</a>) can be very useful.</p>
<p>Beyond checking, <strong>testing</strong> is also an invaluable help for bug-fixing. Various tools may help, including <a class="reference external" href="http://www.quviq.com/products/erlang-quickcheck/">QuickCheck</a>.</p>
<p>Finally, not all errors can be anticipated, from network outages, hardware failures to human factor. An effective last line of defence is to rely on (this time at runtime) <strong>supervision mechanisms</strong> in order to detect any kind of faults (bound to happen, whether expected or not), and overcome them. The OTP framework is an excellent example of such system, much useful to reach higher levels of robustness, including the well-known nine nines - that is an availability of 99.9999999%.</p>
</div>
<div class="section" id="intermediate-languages">
<h2><a class="toc-backref" href="#toc-entry-28">Intermediate Languages</a></h2>
<p>To better discover the inner workings of the Erlang compilation, one may look at the <a class="reference external" href="http://tryerl.seriyps.ru/">eplaypen online demo</a> (whose project is <a class="reference external" href="https://github.com/seriyps/eplaypen">here</a>) and/or at the <a class="reference external" href="https://godbolt.org/">Compiler Explorer</a> (which supports the Erlang language among others).</p>
<p>Both of them allow to read the intermediate representations involved when compiling Erlang code (BEAM stage, erl_scan, preprocessed sources, abstract code, Core Erlang, Static Single Assignment form, BEAM VM assembler opcodes, x86-64 assembler generated by the JIT, etc.).</p>
</div>
</div>
<div class="section" id="short-hints">
<h1><a class="toc-backref" href="#toc-entry-29">Short Hints</a></h1>
<div class="section" id="dealing-with-conditional-availability">
<h2><a class="toc-backref" href="#toc-entry-30">Dealing with Conditional Availability</a></h2>
<div class="section" id="regarding-modules-and-from-the-command-line">
<h3>Regarding modules, and from the command-line</h3>
<p>Depending on how Erlang was built in a given environment, some modules may or may not be available.</p>
<p>A way of determining availability and/or version of a module (e.g. <tt class="docutils literal">wx</tt>, <tt class="docutils literal">cl</tt>, <tt class="docutils literal">crypto</tt>) from the command-line:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>erl<span class="w"> </span>-noshell<span class="w"> </span>-eval<span class="w"> </span><span class="s1">'erlang:display(code:which(wx))'</span><span class="w"> </span>-s<span class="w"> </span>erlang<span class="w"> </span>halt<span class="w">
</span><span class="s2">&quot;/home/bond/Software/Erlang/Erlang-24.2/lib/erlang/lib/wx-2.1.1/ebin/wx.beam&quot;</span><span class="w">

</span>$<span class="w"> </span>erl<span class="w"> </span>-noshell<span class="w"> </span>-eval<span class="w"> </span><span class="s1">'erlang:display(code:which(cl))'</span><span class="w"> </span>-s<span class="w"> </span>erlang<span class="w"> </span>halt<span class="w">
</span>non_existing
</pre>
<p>A corresponding in-makefile test, taken from Wings3D:</p>
<pre class="code makefile literal-block">
<span class="c"># Check if OpenCL package is as external dependency:
</span><span class="nv">CL_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>shell<span class="w"> </span><span class="k">$(</span>ERL<span class="k">)</span><span class="w"> </span>-noshell<span class="w"> </span>-eval<span class="w"> </span><span class="s1">'erlang:display(code:which(cl))'</span><span class="w"> </span>-s<span class="w"> </span>erlang<span class="w"> </span>halt<span class="k">)</span><span class="w">
</span><span class="cp">ifneq (,$(findstring non_existing, $(CL_PATH)))
</span><span class="c">   # Add it if not found:
</span><span class="w">   </span><span class="nv">DEPS</span><span class="o">=</span>cl<span class="w">
</span><span class="cp">endif</span>
</pre>
</div>
<div class="section" id="regarding-language-features-from-code">
<h3>Regarding language features, from code</h3>
<p>Some features appeared in later Erlang versions, and may be conditionally enabled.</p>
<p>For example:</p>
<pre class="code erlang literal-block">
<span class="nv">FullSpawnOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s">&quot;8.1&quot;</span><span class="w"> </span><span class="k">of</span><span class="w">

   </span><span class="n">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
       </span><span class="p">[{</span><span class="n">message_queue_data</span><span class="p">,</span><span class="w"> </span><span class="n">off_heap</span><span class="p">}|</span><span class="nv">BaseSpawnOpts</span><span class="p">];</span><span class="w">

   </span><span class="n">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
       </span><span class="nv">BaseSpawnOpts</span><span class="w">

</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="p">[...]</span>
</pre>
</div>
</div>
<div class="section" id="runtime-library-version">
<h2><a class="toc-backref" href="#toc-entry-31">Runtime Library Version</a></h2>
<p>To know <strong>which version of a library</strong> (here, wxWidgets) a given Erlang install is using (if any), one may run an Erlang shell (<tt class="docutils literal">erl</tt>), collect the PID of this (UNIX) process (e.g. <tt class="docutils literal">ps <span class="pre">-edf</span> | grep beam</tt>), then trigger a use of that library (e.g. for <tt class="docutils literal">wx</tt>, execute <tt class="docutils literal"><span class="pre">wx:demo().</span></tt>) in order to force its dynamic binding.</p>
<p>Then determine its name, for example thanks to <tt class="docutils literal">pmap ${BEAM_PID} | grep libwx</tt>).</p>
<p>This may indicate that for example <tt class="docutils literal"><span class="pre">libwx_gtk2u_core-3.0.so.0.5.0</span></tt> is actually used.</p>
</div>
<div class="section" id="proper-naming">
<h2><a class="toc-backref" href="#toc-entry-32">Proper Naming</a></h2>
<div class="section" id="variable-shorthands">
<h3>Variable Shorthands</h3>
<p>Usually we apply the following conventions:</p>
<ul class="simple">
<li>the <em>head</em> and <em>tail</em> of a list are designated as <tt class="docutils literal">H</tt> and <tt class="docutils literal">T</tt>, like in: <tt class="docutils literal">L = [H|T]</tt></li>
<li><tt class="docutils literal">Acc</tt> means <em>accumulator</em>, in a tail-recursive function</li>
<li><tt class="docutils literal">K</tt> designates a <em>key</em>, and <tt class="docutils literal">V</tt> designates its associated <em>value</em></li>
<li>a list of elements is designated by a plural variable name, usually suffixed with <tt class="docutils literal">s</tt>, like in: <tt class="docutils literal">Ints</tt>, <tt class="docutils literal">Xs</tt>, <tt class="docutils literal">Cars</tt></li>
</ul>
</div>
<div class="section" id="function-pairs">
<h3>Function Pairs</h3>
<p>To better denote reciprocal operations, following namings for functions may be used:</p>
<ul class="simple">
<li>for services:<ul>
<li>activation: <tt class="docutils literal">start</tt> / <tt class="docutils literal">stop</tt></li>
<li>setup: <tt class="docutils literal">init</tt> / <tt class="docutils literal">terminate</tt></li>
</ul>
</li>
<li>for instances:<ul>
<li>life-cycle: <tt class="docutils literal">new</tt> / <tt class="docutils literal">delete</tt></li>
<li>construction/destruction: <tt class="docutils literal">create</tt> / <tt class="docutils literal">destruct</tt> (e.g. avoid <tt class="docutils literal">destroy</tt> there)</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="formatting-erlang-code">
<h2><a class="toc-backref" href="#toc-entry-33">Formatting Erlang Code</a></h2>
<p>Various tools are able to format Erlang code, see <a class="reference external" href="https://github.com/WhatsApp/erlfmt/blob/main/doc/ErlangFormatterComparison.md">this page</a> for a comparison thereof.</p>
<div class="section" id="with-rebar3-format">
<h3>With <tt class="docutils literal">rebar3_format</tt></h3>
<p>For projects already relying on rebar, one may use <a class="reference external" href="https://github.com/AdRoll/rebar3_format">rebar3_format</a> (as a plugin <a class="footnote-reference" href="#footnote-7" id="footnote-reference-7">[9]</a>) that way:</p>
<pre class="code shell literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/Software<span class="w">
</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AdRoll/rebar3_format.git<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>rebar3_format<span class="w">
</span>$<span class="w"> </span><span class="nv">ERL_FLAGS</span><span class="o">=</span><span class="s2">&quot;-enable-feature all&quot;</span><span class="w"> </span>rebar3<span class="w"> </span>format
</pre>
<table class="docutils footnote" frame="void" id="footnote-7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-7">[9]</a></td><td>Note that <tt class="docutils literal">rebar3_format</tt> cannot be used as an escript (so no <tt class="docutils literal"><span class="pre">ERL_FLAGS=&quot;-enable-feature</span> all&quot; rebar3 as release escriptize</tt> shall be issued).</td></tr>
</tbody>
</table>
<p>Then <tt class="docutils literal">{project_plugins, [rebar3_format]}</tt> shall be added to the project's <tt class="docutils literal">rebar.config</tt>.</p>
</div>
<div class="section" id="with-erlfmt">
<h3>With <tt class="docutils literal">erlfmt</tt></h3>
<p>Another tool is <a class="reference external" href="https://github.com/WhatsApp/erlfmt">erlfmt</a>, which can be installed that way:</p>
<pre class="code shell literal-block">
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/Software<span class="w">
</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/WhatsApp/erlfmt<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>erlfmt<span class="w">
</span>$<span class="w"> </span>rebar3<span class="w"> </span>as<span class="w"> </span>release<span class="w"> </span>escriptize
</pre>
<p>And then <tt class="docutils literal">~/Software/erlfmt/_build/release/bin</tt> can be added to one's <tt class="docutils literal">PATH</tt>.</p>
<p>Indeed <tt class="docutils literal">erlfmt</tt> can be used as a rebar plugin or as a standalone escript - which we find useful, especially for projects whose build is not rebar-based.</p>
<p>Running it to reformat in-place source files is then as simple as:</p>
<pre class="code shell literal-block">
$<span class="w"> </span>erlfmt<span class="w"> </span>--write<span class="w"> </span>foo.hrl<span class="w"> </span>bar.erl
</pre>
</div>
</div>
<div class="section" id="language-features">
<h2><a class="toc-backref" href="#toc-entry-34">Language Features</a></h2>
<p>Experimental features (such as <tt class="docutils literal">maybe</tt> in Erlang 25) of the <strong>compiler</strong> (once Erlang has been built, they are <em>potentially available</em>) may have to be specifically <em>enabled</em> at runtime, like in <tt class="docutils literal"><span class="pre">ERL_FLAGS=&quot;-enable-feature</span> all&quot; rebar3 as release escriptize</tt>.</p>
</div>
<div class="section" id="disabling-lco">
<h2><a class="toc-backref" href="#toc-entry-35">Disabling LCO</a></h2>
<p>LCO means here <em>Last Call Optimisation</em>. This consists simply when, in a given module, a (typically exported) function <tt class="docutils literal">f</tt> ends by calling a <em>local</em> function <tt class="docutils literal">g</tt> (i.e. has for last expression a call like <tt class="docutils literal"><span class="pre">g(...)</span></tt>), in not pushing on the stack the call to <tt class="docutils literal">g</tt>, but instead replacing directly the stackframe of <tt class="docutils literal">f</tt> (which can be skipped here, as returning from <tt class="docutils literal">g</tt> will mean directly returning from <tt class="docutils literal">f</tt> as well) with a proper one for <tt class="docutils literal">g</tt>.</p>
<p>This trick spares the use of one level of stack at each ending local call, which is key for recursive functions <a class="footnote-reference" href="#footnote-8" id="footnote-reference-8">[10]</a> (typically for infinitely-looping server processes): they remain then in constant stack space, whereas otherwise the number of their stackframes would grow indefinitely, at each recursive call, and explode in memory.</p>
<table class="docutils footnote" frame="void" id="footnote-8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-8">[10]</a></td><td>When the last call of <tt class="docutils literal">f</tt> branches to <tt class="docutils literal">f</tt> itself, it is named TCO, for <em>Tail Call Optimisation</em> (which is thus a special - albeit essential - case of LCO).</td></tr>
</tbody>
</table>
<p>So LCO is surely not an option for a functional language like Erlang, yet it comes with a drawback: if <tt class="docutils literal">f</tt> ends with a last call to <tt class="docutils literal">g</tt> that ends with a last call to <tt class="docutils literal">h</tt> and a runtime error happens in them, none of these functions will appear in the resulting stacktraces: supposing all these functions use a library <tt class="docutils literal">foobar</tt>, it will be as if the VM directly jumped from the entry point in the user code (typically a function calling <tt class="docutils literal">f</tt>) to the failing point in a function of <tt class="docutils literal">foobar</tt>; there will be no line number pointing to the expression of <tt class="docutils literal">f</tt>,  <tt class="docutils literal">g</tt> or <tt class="docutils literal">h</tt> that triggers the faulty behaviour, whereas this is probably the information we are mostly interested in - as these functions may make numerous calls to <tt class="docutils literal">foobar</tt>'s function. This makes the debugging unnecessarily difficult.</p>
<p>Yet various workarounds exist (see <a class="reference external" href="https://erlangforums.com/t/disabling-tco-selectively/3091">this topic</a> for more information) - just for debugging purposes - so that given &quot;suspicious&quot; functions (here <tt class="docutils literal">f</tt>,  <tt class="docutils literal">g</tt> or <tt class="docutils literal">h</tt>) are not LCO'ed:</p>
<ul class="simple">
<li>to have their returned values wrapped in a remote call to an identity function (we use <tt class="docutils literal">basic_utils:identity/1</tt> for that)</li>
<li>or to have them wrapped (at least their end, i.e. their last expression(s)) with <tt class="docutils literal">try ... catch E <span class="pre">-&gt;</span> throw(E) end</tt></li>
<li>or to return-trace these functions, as it temporarily disables LCO and allows to be very selective (one can limit this to a specific process or certain conditions, with match specs; refer to <a class="reference external" href="https://www.erlang.org/doc/man/dbg.html">dbg</a> for more details; note that the module of interest must be compiled with <tt class="docutils literal">debug_info</tt> so that it can be traced)</li>
</ul>
<p>The first workaround is probably the simplest, when operating on &quot;suspicious&quot; modules of interest (knowing that LCO <em>is</em> useful, and should still apply to most essential server-like processes).</p>
<p>One can nevertheless note that unfortunately LCO is not the only cause for the vanishing of calls in the stacktrace (even in the absence of any function inlining).</p>
<p>Within <a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a>, if the (non-default) <tt class="docutils literal">myriad_disable_lco</tt> compilation option is set (typically with the <tt class="docutils literal"><span class="pre">-Dmyriad_disable_lco</span></tt> command-line flag), this workaround is applied automatically on the modules on which the Myriad parse transform operates - i.e. all but bootstrapped modules (refer to the <tt class="docutils literal">lco_disabling_clause_transform_fun/2</tt> function of the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/src/meta/myriad_parse_transform.erl">myriad_parse_transform</a> module).</p>
</div>
<div class="section" id="using-wx">
<h2><a class="toc-backref" href="#toc-entry-36">Using wx</a></h2>
<p><a class="reference external" href="https://www.erlang.org/doc/man/wx.html">wx</a> is now <a class="footnote-reference" href="#footnote-9" id="footnote-reference-9">[11]</a> the standard Erlang way of programming one's graphical user interface; it is a binding to the <a class="reference external" href="http://www.wxwidgets.org/">wxWidgets</a> library.</p>
<table class="docutils footnote" frame="void" id="footnote-9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-9">[11]</a></td><td><tt class="docutils literal">wx</tt> replaced <a class="reference external" href="https://www.erlang.org/docs/18/man/gs.html">gs</a>. To shelter already-developed graphical applications from any future change of backend, we developed <a class="reference external" href="https://myriad.esperide.org/#graphical-user-interface-gui">MyriadGUI</a>, an interface doing its best to hide the underlying graphical backend at hand: should the best option in Erlang change, that API would have to be ported to the newer backend, hopefully with little to (ideally) no change in the user applications.</td></tr>
</tbody>
</table>
<p>Here are some very general wx-related information that may be of help when programming GUIs with this backend:</p>
<ul class="simple">
<li>in wxWidgets parlance, &quot;window&quot; designates any kind of widget (not only frame-like elements)</li>
<li>if receiving errors about <tt class="docutils literal"><span class="pre">{badarg,&quot;This&quot;}</span></tt>, like in:</li>
</ul>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="n">'_wxe_error_'</span><span class="p">,</span><span class="mi">710</span><span class="p">,{</span><span class="n">wxDC</span><span class="p">,</span><span class="n">setPen</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">badarg</span><span class="p">,</span><span class="s">&quot;This&quot;</span><span class="p">}}</span>
</pre>
<p>it is probably the sign that the user code attempted to perform an operation on an already-deallocated wx object; the corresponding life-cycle management might be error-prone, as some deallocations are implicit, others are explicit, and in a concurrent context race conditions easily happen</p>
<ul class="simple">
<li>if creating, from a wx-using process, another one, this one should set a relevant environment first (see <tt class="docutils literal">wx:set_env/1</tt>) before using wx functions</li>
<li>the <a class="reference external" href="https://docs.wxwidgets.org/latest/overview_events.html#overview_events_propagation">way wx/wxWidgets manage event propagation</a> is complex; here are some elements:<ul>
<li>for each actual event happening, wx creates an instance of <a class="reference external" href="https://docs.wxwidgets.org/latest/classwx_event.html">wxEvent</a> (a direct, abstract child class of <tt class="docutils literal">wxObject</tt>), which itself is specialised into many event classes that are more concrete</li>
<li>among them, they are so-called <em>command events</em>, which originate from a variety of simple controls and correspond to the <a class="reference external" href="https://docs.wxwidgets.org/latest/classwx_command_event.html">wxCommandEvent</a> mother class; by default only these command events are set to propagate, i.e. only them will be transmitted to the event handler of the parent widget if the current one does not process them by itself (&quot;did not connect to them&quot;)</li>
<li>by default, for a given type of event, when defining one's event handler (typically when connecting a process to the emitter of such events), this event will <em>not</em> be propagated anymore, possibly preventing the built-in wx event handlers to operate (e.g. to properly manage resizings); to restore their activation, <tt class="docutils literal">skip</tt> (to be understood here as &quot;propagate event&quot; - however counter-intuitive it may seem) shall be set to <tt class="docutils literal">true</tt> (either by passing a corresponding option when connecting, or by calling <tt class="docutils literal">wxEvent:skip/2</tt> with <tt class="docutils literal">skip</tt> set to <tt class="docutils literal">true</tt> from one's event handler) <a class="footnote-reference" href="#footnote-10" id="footnote-reference-10">[12]</a></li>
<li>when a process connects to the emitter of a given type of events (e.g. <tt class="docutils literal">close_window</tt> for a given frame), this process is to receive corresponding messages and then perform any kind of operation; however these operations cannot be synchronous (they are non-blocking: the process does not send to anyone any notification that it finished handling that event), and thus, if <tt class="docutils literal">skip</tt> is <tt class="docutils literal">true</tt> (that is, if event propagation is enabled), any other associated event handler(s) will be triggered concurrently to the processing of these event messages; this may be a problem for example if a controller listens to the <tt class="docutils literal">close_window</tt> event emitted by a main frame in order to perform a proper termination: the basic, built-in event handlers will then by default be triggered whereas the controller teardown may be still in progress, and this may result in errors (e.g. OpenGL ones, like <tt class="docutils literal"><span class="pre">{{{badarg,&quot;This&quot;},{wxGLCanvas,swapBuffers,1}},...</span></tt> because the built-in close handlers already deallocated the OpenGL context); a proper design is to ensure that <tt class="docutils literal">skip</tt> remains set to false so that propagation of such events is disabled in these cases: then only the user code is in charge of closing the application, at its own pace <a class="footnote-reference" href="#footnote-11" id="footnote-reference-11">[13]</a></li>
</ul>
</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-10">[12]</a></td><td>MyriadGUI took a different convention: whether an event will propagate by default depends on its type, knowing that most of the types are to propagate. Yet the user can override these default behaviours, by specifying either the <tt class="docutils literal">trap_event</tt> or the <tt class="docutils literal">propagate_event</tt> subscription option, or by calling either the <tt class="docutils literal">trap_event/1</tt> or the <tt class="docutils literal">propagate_event/1</tt> function.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-11">[13]</a></td><td>This is why MyriadGUI applies per-event type defaults, thus possibly trapping events; in this case, if the built-in backend mechanisms would still be of use, they can be triggered by calling the <tt class="docutils literal">propagate_event/1</tt> function from the user-defined handler, only once all its prerequisite operations have been performed (this is thus a way of restoring sequential operations).</td></tr>
</tbody>
</table>
<ul class="simple">
<li>in terms of sizing, the dimensions of a parent widget prevail: its child widgets have to adapt (typically with sizers); if wanting instead that the size of a child dictates the one of its parent, the size of the client area of the parent should be set to the best size of its child, or its <tt class="docutils literal">fit/1</tt> method shall be called</li>
</ul>
<p>Extra information resources about <tt class="docutils literal">wx</tt> (besides the documentation of its modules):</p>
<ul class="simple">
<li>the graphical <a class="reference external" href="https://docs.wxwidgets.org/latest/classwx_window.html">class hierarchy of the wxWindow class</a>, as this class corresponds to the concept of widget, which is very central</li>
<li><a class="reference external" href="https://docs.wxwidgets.org/latest/page_screenshots.html">graphical repositories of most widgets</a> (screenshots thereof)</li>
<li>wxErlang: <a class="reference external" href="https://arifishaq.files.wordpress.com/2017/12/wxerlang-getting-started.pdf">Getting started</a> and <a class="reference external" href="https://arifishaq.files.wordpress.com/2018/04/wxerlang-speeding-up.pdf">Speeding up</a>, by Arif Ishaq</li>
<li>Doug Edmunds' <a class="reference external" href="http://wxerlang.dougedmunds.com/">wxerlang workups</a></li>
<li><a class="reference external" href="https://www.wxwidgets.org/">wxWidgets itself</a></li>
</ul>
</div>
<div class="section" id="installing-rebar3">
<h2><a class="toc-backref" href="#toc-entry-37">Installing rebar3</a></h2>
<p>One may use our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/install-rebar3.sh">install-rebar3.sh</a> script for that (installed from sources, or prebuilt).</p>
</div>
</div>
<div class="section" id="micro-cheat-sheet">
<h1><a class="toc-backref" href="#toc-entry-38">Micro-Cheat Sheet</a></h1>
<p>To avoid having to perform a lookup in the documentation:</p>
<ul class="simple">
<li>Erlang indices start at <tt class="docutils literal">1</tt>, except the ones of the <tt class="docutils literal">array</tt> module that are zero-based</li>
<li>when they yield the same result, <tt class="docutils literal">=:=</tt> is a bit more efficient than <tt class="docutils literal">==</tt></li>
<li>for tuples of unknown number of elements:<ul>
<li><strong>setting</strong> an element is to be done with <tt class="docutils literal"><span class="pre">setelement(positive_index(),</span> <span class="pre">tuple(),</span> <span class="pre">term())</span> <span class="pre">-&gt;</span> tuple()</tt></li>
<li><strong>extracting</strong> an element is to be done with <tt class="docutils literal"><span class="pre">element(positive_index(),</span> <span class="pre">tuple())</span> <span class="pre">-&gt;</span> term()</tt></li>
<li><strong>adding</strong> an element at a given index (e.g. to append a record tag) is to be done with <tt class="docutils literal"><span class="pre">erlang:insert_element(positive_index(),</span> <span class="pre">tuple(),</span> <span class="pre">term())</span> <span class="pre">-&gt;</span> tuple()</tt></li>
<li><strong>removing</strong> an element at a given index (e.g. to chop a record tag) is to be done with <tt class="docutils literal"><span class="pre">erlang:delete_element(positive_index(),</span> <span class="pre">tuple())</span> <span class="pre">-&gt;</span> tuple()</tt></li>
</ul>
</li>
</ul>
<p>(no need for the <tt class="docutils literal">erlang</tt> module to be explicitly specified for the first two functions, as both are auto-imported)</p>
<ul class="simple">
<li>for <tt class="docutils literal">maps</tt>: refer to <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#map_expressions">map expressions</a>, the <a class="reference external" href="https://www.erlang.org/doc/man/maps.html">maps module</a> and the corresponding part of the <a class="reference external" href="https://www.erlang.org/doc/efficiency_guide/maps.html">efficiency guide</a>; in short:<ul>
<li>creating/updating maps is <tt class="docutils literal">EmptyMap = #{}</tt>, <tt class="docutils literal">NewMFromScratch = #{K1 =&gt; V1, K2 =&gt; V2}</tt> or <tt class="docutils literal">UpdatedM = <span class="pre">M#{K1</span> =&gt; V1, K2 =&gt; V2}</tt></li>
<li>updating the value associated to an already-existing key <tt class="docutils literal">K</tt> is <tt class="docutils literal">ModM = <span class="pre">M#{K</span> := V}</tt></li>
<li>matching is <tt class="docutils literal">#{K1 := V1, K2 := V2} = M</tt> where the <tt class="docutils literal">K*</tt> are <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#guard_expressions">guard expressions</a> and the <tt class="docutils literal">V*</tt> can be any pattern; matching an empty map is best done with <tt class="docutils literal">when Map == #{}</tt></li>
<li>obtaining the value <tt class="docutils literal">V</tt> associated to a key <tt class="docutils literal">K</tt> that:<ul>
<li>is expected to exist: <tt class="docutils literal">V = maps:get(K, MyMap)</tt> (generally could/should be directly matched instead)</li>
<li>may or may not exist: <tt class="docutils literal">case maps:find(K, MyMap) of {ok, V} <span class="pre">-&gt;</span> <span class="pre">...;</span> error <span class="pre">-&gt;</span> ... end</tt></li>
</ul>
</li>
<li>removing an entry: <tt class="docutils literal">ShrunkMap = maps:remove(Key,Map)</tt></li>
</ul>
</li>
<li>to detect in a guard whether a term is a map, there is no <tt class="docutils literal">is_map/1</tt> guard available: <tt class="docutils literal">map_size/1</tt> will fail the guard if its argument is not a map; a map includes its size in the header word, so <tt class="docutils literal">map_size/1</tt> is O(1); furthermore, the JIT will inline calls to <tt class="docutils literal">map_size/1</tt></li>
<li>a rule of thumb for naming in Erlang/OTP is that functions having <tt class="docutils literal">size</tt> in their name are O(1), while functions having <tt class="docutils literal">length</tt> in their name are O(N)</li>
<li>when converting a float to a string, to set the precision (the number of digits after the decimal point) to <tt class="docutils literal">P</tt>, use: <tt class="docutils literal"><span class="pre">&quot;~.Pf&quot;</span></tt>; for example, if <tt class="docutils literal">P=5</tt>, we have: <tt class="docutils literal">&quot;0.33333&quot; = <span class="pre">io_lib:format(&quot;~.5f&quot;,</span> <span class="pre">[1/3]).</span></tt></li>
<li>the lesser-known <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#list-operationslist">&quot;--&quot; list subtraction</a> operator returns a list that is a copy of the first argument where, for each element in the second argument, the first occurrence of this element (if any) is removed</li>
<li>refer to the <a class="reference external" href="https://www.erlang.org/doc/reference_manual/data_types.html#escape-sequences">escape sequences</a>, typically in order to specify characters like &quot;space&quot; (<tt class="docutils literal">$\s</tt>); <tt class="docutils literal">$char</tt> is the notation to designate the ASCII value or Unicode code-point of the character <tt class="docutils literal">char</tt> (e.g. <tt class="docutils literal">$A</tt>)</li>
<li>see the always handy <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#operator-precedence">operator precedence</a> and the various ways to <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#try">handle exceptions with try/catch</a>; note that to catch <em>all</em> exceptions - i.e. those of the <tt class="docutils literal">throw</tt> class, but also of the <tt class="docutils literal">exit</tt> and <tt class="docutils literal">error</tt> classes, one may use: <tt class="docutils literal">try EXPR catch _:E <span class="pre">-&gt;</span> ...</tt> (rather than just: <tt class="docutils literal">try EXPR catch E <span class="pre">-&gt;</span> ...</tt>)</li>
<li>in <strong>guard expressions</strong>:<ul>
<li>to express an &quot;and&quot; operator, use a comma, i.e. &quot;<tt class="docutils literal">,</tt>&quot;, like in <tt class="docutils literal">f(A, B, C, D) when A =:= B, C =:= A + D <span class="pre">-&gt;</span></tt></li>
<li>to express an &quot;or&quot; operator, use a semi-colon, i.e. &quot;<tt class="docutils literal">;</tt>&quot;</li>
<li><tt class="docutils literal">andalso</tt> and <tt class="docutils literal">orelse</tt> behave there as tests, and their code is a little less effective than &quot;<tt class="docutils literal">,</tt>&quot; and &quot;<tt class="docutils literal">;</tt>&quot;</li>
<li>refer to the two tables (test/others) of the <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#guard-expressions">BIFs supported in guards expressions</a></li>
</ul>
</li>
<li>to handle <strong>binaries</strong>:<ul>
<li>one may refer to <a class="reference external" href="https://cheatography.com/fylke/cheat-sheets/erlang-binaries/">this cheat sheet</a>; see also an <a class="reference external" href="https://www.erlang.org/doc/programming_examples/bit_syntax.html">introduction to the bit syntax</a> (including <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#bit-string-comprehensions">bit string comprehensions</a>) and its <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#bit_syntax">full reference</a>, the <a class="reference external" href="https://www.erlang.org/doc/efficiency_guide/binaryhandling.html">Constructing and Matching Binaries</a> section and the <a class="reference external" href="https://www.erlang.org/doc/man/binary.html">binary</a> module; see also our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/src/data-management/bin_utils.erl">bin_utils</a> module</li>
<li>as a rule of thumb:<ul>
<li>even if it may seem a bit counter-intuitive, <em>integers</em> (the default matching type) are handled at the bit level (e.g. <tt class="docutils literal">A:16</tt> means an integer on two bytes), whereas <em>binaries</em> are handled at the byte level (e.g. <tt class="docutils literal">B:16/binary</tt> means 16 bytes) - indeed their bit-level counterparts are <em>bitstrings</em></li>
<li>unlike lists, binaries are preferably built by appending <a class="reference external" href="https://www.erlang.org/doc/efficiency_guide/binaryhandling.html#constructing-binaries">on their right</a></li>
</ul>
</li>
</ul>
</li>
<li>typically for non-critical code (e.g. tests or temporary, debugging code):<ul>
<li>to avoid repeating a prefixing module, <a class="reference external" href="https://www.erlang.org/doc/reference_manual/modules#pre-defined-module-attributes">imports can be done</a>, like in: <tt class="docutils literal"><span class="pre">-import(lists,</span> [map/2, foldl/3, <span class="pre">foldr/3]).</span></tt></li>
<li>to suppress warnings/errors whenever variables are not used: <tt class="docutils literal"><span class="pre">-compile(nowarn_unused_vars).</span></tt></li>
</ul>
</li>
<li>in boolean expressions <strong>outside of guards</strong>:<ul>
<li>do not use <tt class="docutils literal">and</tt> and <tt class="docutils literal">or</tt>, which are strict boolean operators, not intended for control; indeed their precedence is low (parentheses around the conditions being then necessary, like in <tt class="docutils literal">(A =:= B) and (C =:= D)</tt>) and, more importantly, they do not short-circuit, i.e. in <tt class="docutils literal">E = A and B</tt>, B will be evaluated even if A is already known as false (so is E), and in <tt class="docutils literal">E = A or B</tt>, B will be evaluated even if A is already known as true (so is E)</li>
<li>prefer <tt class="docutils literal">andalso</tt> and <tt class="docutils literal">orelse</tt>, which are <em>control</em> operators; they short-circuit, and their precedence is <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#operator-precedence">low enough</a> to spare the need of extra parentheses <a class="footnote-reference" href="#footnote-12" id="footnote-reference-12">[14]</a></li>
<li>so <tt class="docutils literal">case (A =:= B) and (C =:= D) of</tt> shall become <tt class="docutils literal">case A =:= B andalso C =:= D of</tt></li>
<li>a common pattern is to use <tt class="docutils literal">andalso</tt> in order <em>to evaluate a target expression iff a boolean expression is true</em>, to replace a longer expression like:</li>
</ul>
</li>
</ul>
<pre class="code erlang literal-block">
<span class="k">case</span><span class="w"> </span><span class="nv">BOOLEAN_EXPR</span><span class="w"> </span><span class="k">of</span><span class="w">

    </span><span class="n">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nv">DO_SOMETHING</span><span class="p">;</span><span class="w">

    </span><span class="n">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">ok</span><span class="w">

</span><span class="k">end</span>
</pre>
<table class="docutils footnote" frame="void" id="footnote-12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-12">[14]</a></td><td><p class="first">Note that it is <em>not</em> the case of the <tt class="docutils literal">and</tt> and <tt class="docutils literal">or</tt> operators, whose precedence is higher than, notably, the comparison operators.</p>
<p class="last">For example a clause defined as <tt class="docutils literal">f(I) when is_integer(I) and I &gt;= 0 <span class="pre">-&gt;</span> ...</tt>  will never be triggered as it is interpreted as <tt class="docutils literal">f(I) when (is_integer(I) and I) &gt;= 0 <span class="pre">-&gt;</span> ...</tt>, and the <tt class="docutils literal">and</tt> guard will always fail as I is an integer here, not a boolean. So such a clause should be defined as the (correct) <tt class="docutils literal">f(I) when is_integer(I) andalso I &gt;= 0 <span class="pre">-&gt;</span> ...</tt> instead.</p>
</td></tr>
</tbody>
</table>
<p>with the equivalent (provided <tt class="docutils literal">BOOLEAN_EXPR</tt> evaluates to either <tt class="docutils literal">true</tt> or <tt class="docutils literal">false</tt> - otherwise a <tt class="docutils literal">bad argument</tt> exception will be thrown) yet shorter: <tt class="docutils literal">BOOLEAN_EXPR andalso DO_SOMETHING</tt>; for example: <tt class="docutils literal"><span class="pre">[...],</span> OSName =:= linux andalso <span class="pre">fix_for_linux(),</span> <span class="pre">[...]</span></tt></p>
<p>Similarly, <tt class="docutils literal">orelse</tt> can be used <em>to evaluate a target expression iff a boolean expression is false</em>, to replace a longer expression like:</p>
<pre class="code erlang literal-block">
<span class="k">case</span><span class="w"> </span><span class="nv">BOOLEAN_EXPR</span><span class="w"> </span><span class="k">of</span><span class="w">

    </span><span class="n">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">ok</span><span class="p">;</span><span class="w">

    </span><span class="n">false</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nv">DO_SOMETHING</span><span class="p">;</span><span class="w">

</span><span class="k">end</span>
</pre>
<p>with: <tt class="docutils literal">BOOLEAN_EXPR orelse DO_SOMETHING</tt>; for example: <tt class="docutils literal"><span class="pre">[...],</span> <span class="pre">file_utils:exists(&quot;/etc/passwd&quot;)</span> orelse throw(no_password_file), <span class="pre">[...]</span></tt></p>
<p>In both <tt class="docutils literal">andalso / orelse</tt> cases, the <tt class="docutils literal">DO_SOMETHING</tt> branch may be a single expression, or a sequence thereof (i.e. a body), in which case a <tt class="docutils literal">begin/end</tt> block may be of use, like in:</p>
<pre class="code erlang literal-block">
<span class="nn">file_utils</span><span class="p">:</span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;/etc/passwd&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">orelse</span><span class="w">
  </span><span class="k">begin</span><span class="w">
      </span><span class="nn">trace_utils</span><span class="p">:</span><span class="nf">notice</span><span class="p">(</span><span class="s">&quot;No /etc/password found.&quot;</span><span class="p">),</span><span class="w">
      </span><span class="n">throw</span><span class="p">(</span><span class="n">no_password_file</span><span class="p">)</span><span class="w">
  </span><span class="k">end</span>
</pre>
<p>Similarly, taking into account the aforementioned precedences, <tt class="docutils literal">Count =:= ExpectedCount orelse <span class="pre">throw({invalid_count,</span> Count})</tt> will perform the expected check.</p>
<p>Be wary of not having <a class="reference external" href="https://www.erlang.org/doc/reference_manual/expressions.html#operator-precedence">precedences wrong</a>, lest bugs are introduced like the one in:</p>
<pre class="code erlang literal-block">
<span class="nv">MaybeListenerPid</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="ow">orelse</span><span class="w">
   </span><span class="nv">MaybeListenerPid</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="n">onDeserialisation</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">self</span><span class="p">(),</span><span class="w"> </span><span class="nv">FinalUserData</span><span class="p">]}</span>
</pre>
<p>(<tt class="docutils literal">orelse</tt> having more priority than <tt class="docutils literal">!</tt>, parentheses shall be added, otherwise, if having a PID, the message will actually be sent to any process that would be registered as <tt class="docutils literal">true</tt>)</p>
<p>Some of these elements have been adapted from the <a class="reference external" href="https://github.com/dgud/wings/blob/master/CodingGuidelines">Wings3D coding guidelines</a>.</p>
</div>
<div class="section" id="erlang-resources">
<h1><a class="toc-backref" href="#toc-entry-39">Erlang Resources</a></h1>
<ul class="simple">
<li>the reference is the <a class="reference external" href="http://erlang.org">Erlang official website</a></li>
<li>for teaching purpose, we would dearly recommend <a class="reference external" href="https://learnyousomeerlang.com/content">Learn You Some Erlang for Great Good!</a>; many other high-quality <a class="reference external" href="https://erlangforums.com/c/erlang-learning-resources/8">Erlang books</a> exist as well; one may also check the <a class="reference external" href="https://exercism.org/tracks/erlang">Erlang track</a> on Exercism</li>
<li>in addition to the module index mentioned in the <a class="reference internal" href="#erlang-installation">Erlang Installation</a> section, using the <a class="reference external" href="https://erlang.org/doc/search/">online search</a> and/or <a class="reference external" href="https://erldocs.com/">Erldocs</a> may also be convenient</li>
<li>the Erlang <a class="reference external" href="https://www.erlang.org/community">community</a> is known to be pleasant and welcoming to newcomers; one may visit the <a class="reference external" href="https://erlangforums.com/">Erlang forums</a>, which complement the <a class="reference external" href="https://erlang.org/pipermail/erlang-questions/">erlang-questions</a> mailing list (use <a class="reference external" href="https://groups.google.com/g/erlang-programming">this mirror</a> in order to search through the past messages of this list)</li>
<li>for those who are interested in parse transforms (the Erlang way of doing metaprogramming), the <a class="reference external" href="https://www.erlang.org/doc/apps/erts/absform.html">section about The Abstract Format</a> is essential (despite not being well known)</li>
<li>to better understand the inner workings of the VM: <a class="reference external" href="https://blog.stenmans.org/theBeamBook/">The Erlang Runtime System</a>, a.k.a. &quot;the BEAM book&quot;, by Erik Stenman</li>
<li><a class="reference external" href="http://beam-wisdoms.clau.se/en/latest">BEAM Wisdoms</a>, by Dmytro Lytovchenko</li>
</ul>
<p><span class="raw-html"><a name="howtos_bottom"></a></span></p>
</div>
</div>
</body>
</html>
