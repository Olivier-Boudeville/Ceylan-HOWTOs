<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<title>Ceylan-HOWTOs: About Network Management</title>
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="howtos.css" type="text/css" />
<link href="howtos-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="network-management">
<h1 class="title">Network Management</h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="howtos_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Ceylan HOWTOs</em> <a href="http://howtos.esperide.org">browse latest</a> <a href="Ceylan-HOWTOs-english.pdf">get PDF</a> <a href="#howtos_top">go to top</a> <a href="#howtos_toc">go to toc</a> <a href="#howtos_bottom">go to bottom</a> <a href="Ceylan-HOWTOs-overview-english.html">go to HOWTOs</a> <a href="mailto:about(dash)ceylan-howtos(at)esperide(dot)com?subject=[Ceylan-HOWTOs]%20Remark%20about%20Network%20Management">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="howtos-title.png" id="responsive-image-ultrasmall"></img></span></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body">Copyright (C) 2021-2023 Olivier Boudeville</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body">about (dash) howtos (at) esperide (dot) com</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body">Saturday, November 20, 2021</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Saturday, January 28, 2023</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"><a name="howtos_toc"></a></span></p>
<div class="contents local topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#investigating-network-issues" id="toc-entry-1">Investigating Network Issues</a></li>
<li><a class="reference internal" href="#firewall-management" id="toc-entry-2">Firewall Management</a><ul>
<li><a class="reference internal" href="#configuration-of-a-gateway-to-the-internet" id="toc-entry-3">Configuration of a Gateway to the Internet</a></li>
<li><a class="reference internal" href="#firewall-related-troubleshooting" id="toc-entry-4">Firewall-related Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#network-troubleshooting" id="toc-entry-5">Network Troubleshooting</a></li>
<li><a class="reference internal" href="#see-also" id="toc-entry-6">See Also</a></li>
</ul>
</div>
<p><span class="raw-html"></center></span></p>
<div class="section" id="investigating-network-issues">
<h1><a class="toc-backref" href="#toc-entry-1">Investigating Network Issues</a></h1>
<p>Tools like <tt class="docutils literal">ping</tt>, <tt class="docutils literal">traceroute</tt>, <tt class="docutils literal">drill</tt>, <tt class="docutils literal">arp</tt>, etc. are invaluable.</p>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/ip-scan.sh">ip-scan.sh</a> to scans all IPs with any specified prefix, and <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/ip-examine.sh">ip-examine.sh</a> to collect information about a given IP.</p>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/monitor-network.sh">monitor-network.sh</a> to investigate unstable connections.</p>
</div>
<div class="section" id="firewall-management">
<h1><a class="toc-backref" href="#toc-entry-2">Firewall Management</a></h1>
<p>On GNU/Linux, some level of knowledge about <tt class="docutils literal">iptables</tt> is useful, notably if exposing a computer to the Internet; note though that it is to be superseded by <a class="reference external" href="https://wiki.archlinux.org/title/Nftables">nftables</a>.</p>
<p>One should read first the very clear Arch wiki section about <a class="reference external" href="https://wiki.archlinux.org/title/iptables#Basic_concepts">iptables basic concepts</a>.</p>
<p>A general rule that we retain, especially for an Internet gateway, is to drop all packets by default, and then only to accept the expected ones explicitly and carefully.</p>
<div class="section" id="configuration-of-a-gateway-to-the-internet">
<h2><a class="toc-backref" href="#toc-entry-3">Configuration of a Gateway to the Internet</a></h2>
<p>Our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script sets up an iptables configuration with various services that can be enabled (ex: for masquerading, IPTV, different kinds of servers) as an example that we hope is secure enough <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>Please email us if you found otherwise! Refer to the top of this document for that.</td></tr>
</tbody>
</table>
<p>This script expects a settings file to be available as <tt class="docutils literal"><span class="pre">/etc/iptables.settings-Gateway.sh</span></tt> (this file is meant to be sourced, not executed).</p>
<p>An example thereof:</p>
<pre class="code bash literal-block">
<span class="c1"># Local firewall settings.
#
# Meant to be sourced by the iptables.rules-Gateway.sh script.
</span><span class="w">
</span><span class="c1"># Where firewall-related outputs will be written:
</span><span class="nv">log_file</span><span class="o">=</span>/root/.last-gateway-firewall-activation<span class="w">

</span><span class="c1"># Local (LAN) interface, the one we trust:
#lan_if=eth1
</span><span class="nv">lan_if</span><span class="o">=</span>enp2s0<span class="w">

</span><span class="c1"># Internet (WAN) interface, the one we distrust:
</span><span class="w">
</span><span class="c1"># For PPP ADSL connections:
#net_if=ppp0
</span><span class="w">
</span><span class="c1"># For direct connection to a set-top (telecom) box from your provider:
#net_if=eth0
</span><span class="nv">net_if</span><span class="o">=</span>enp4s0<span class="w">

</span><span class="nv">ban_file</span><span class="o">=</span><span class="s2">&quot;/etc/ban-rules.iptables&quot;</span><span class="w">

</span><span class="c1"># As the IPs banned through the ban file above are quite minimal:
</span><span class="nv">use_ban_rules</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w">
</span><span class="c1">#use_ban_rules=&quot;false&quot;
</span><span class="w">
</span><span class="c1"># IP of a test client (to avoid too many logs, selecting only related events):
#test_client_ip=&quot;xxx&quot;
</span><span class="w">
</span><span class="c1"># Enabled input TCP port range for traffic from LAN to gateway:
</span><span class="nv">enable_unfiltered_tcp_range</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w">

</span><span class="c1"># TCP unfiltered window (ex: for passive FTP and BEAM port ranges):
</span><span class="nv">tcp_unfiltered_low_port</span><span class="o">=</span><span class="m">50000</span><span class="w">
</span><span class="nv">tcp_unfiltered_high_port</span><span class="o">=</span><span class="m">55000</span><span class="w">

</span><span class="c1"># Tells whether IPTV (TV on the Internet thanks to a box) should be allowed:
</span><span class="nv">enable_iptv</span><span class="o">=</span><span class="nb">false</span><span class="w">

</span><span class="c1"># Tells whether a SMTP server can be used:
</span><span class="nv">enable_smtp</span><span class="o">=</span><span class="nb">false</span><span class="w">

</span><span class="c1"># Typically a set-top box from one's ISP (defined as a possibly log match
# criteria):
</span><span class="w">
</span><span class="c1"># Classical example:
</span><span class="nv">telecom_box</span><span class="o">=</span><span class="s2">&quot;192.168.0.254&quot;</span><span class="w">

</span><span class="c1"># DHT subsection, for P2P exchanges:
# More infos: https://github.com/rakshasa/rtorrent/wiki/Using-DHT
</span><span class="w">
</span><span class="nv">dht_udp_port</span><span class="o">=</span><span class="m">7881</span><span class="w">

</span><span class="c1">#use_dht=&quot;true&quot;
</span><span class="nv">use_dht</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="w">

</span><span class="c1"># One may use a non-standard port:
#ssh_port=22
</span><span class="nv">ssh_port</span><span class="o">=</span><span class="m">22320</span><span class="w">

</span><span class="nv">smtp_port</span><span class="o">=</span><span class="m">25</span><span class="w">

</span><span class="c1"># SMTPS is obsolete:
</span><span class="nv">smtp_secure_port</span><span class="o">=</span><span class="m">465</span><span class="w">

</span><span class="c1"># STARTTLS over SMTP is the proper way of securing SMTP:
</span><span class="nv">msa_port</span><span class="o">=</span><span class="m">587</span><span class="w">

</span><span class="nv">pop3_port</span><span class="o">=</span><span class="m">110</span><span class="w">

</span><span class="c1"># POP3S:
</span><span class="nv">pop3_secure_port</span><span class="o">=</span><span class="m">995</span><span class="w">

</span><span class="nv">imap_port</span><span class="o">=</span><span class="m">143</span><span class="w">
</span><span class="nv">imap_secure_port</span><span class="o">=</span><span class="m">993</span>
</pre>
<p>A script to configure iptables is best integrated to systemd, see the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.service">iptables.rules-Gateway.service</a> file for that (typically to be placed in <tt class="docutils literal">/etc/systemd/system</tt>). Then one may test with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>iptables.rules-Gateway.service
</pre>
<p>and enable it for good with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>iptables.rules-Gateway.service
</pre>
<p>Note that often these scripts are setup remotely, while being connected thanks to SSH from another host. Care must be taken in order not to lock oneself out of the target server, notably when updating rules (this happens quite easily). We advise to prefer the <tt class="docutils literal">restart</tt> option of our iptables script in order to reduce the risk of &quot;bricking&quot; one's server.</p>
</div>
<div class="section" id="firewall-related-troubleshooting">
<h2><a class="toc-backref" href="#toc-entry-4">Firewall-related Troubleshooting</a></h2>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables-inspect.sh">iptables-inspect.sh</a> to list the currently-used firewall rules for the chains of the main tables. Like <tt class="docutils literal">iptables <span class="pre">-nL</span> <span class="pre">--line-numbers</span></tt>, it displays the number of each rule of a given chain, which allows to add/remove rules more easily, like in:</p>
<pre class="code bash literal-block">
<span class="c1"># Deletes the first rule of the FORWARD chain (of the 'filter' table):
# (note that all the next rules will bear a decremented number afterwards!)
</span>$<span class="w"> </span>iptables<span class="w"> </span>-D<span class="w"> </span>FORWARD<span class="w"> </span><span class="m">1</span>
</pre>
<p>Setting environment variables (either through files such as <tt class="docutils literal"><span class="pre">/etc/iptables.settings-Gateway.sh</span></tt> or directly in the shell) is less error-prone; ex:</p>
<pre class="code bash literal-block">
<span class="o">[</span>...<span class="o">]</span><span class="w">
</span>$<span class="w"> </span><span class="nv">lan_if</span><span class="o">=</span>enp2s0<span class="w">
</span>$<span class="w"> </span><span class="nv">net_if</span><span class="o">=</span>enp4s0<span class="w">
</span>$<span class="w"> </span>iptables<span class="w"> </span>-I<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span><span class="si">${</span><span class="nv">lan_if</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">net_if</span><span class="si">}</span><span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">telecom_box</span><span class="si">}</span><span class="w"> </span>-j<span class="w"> </span>LOG<span class="w">
</span>$<span class="w"> </span>journalctl<span class="w"> </span>-kf<span class="w"> </span>--grep<span class="o">=</span><span class="s2">&quot;IN=.*OUT=.*&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;SRC=</span><span class="si">${</span><span class="nv">telecom_box</span><span class="si">}</span><span class="s2">&quot;</span>
</pre>
<p>To further match packets, one may specify log prefixes, like in:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>lan.foobar<span class="w"> </span>-j<span class="w"> </span>LOG<span class="w"> </span>--log-prefix<span class="w"> </span><span class="s2">&quot;[VLAN INP FOO]&quot;</span>
</pre>
<p>Note that the <tt class="docutils literal">LOG</tt> target does not intercept a packet, which thus continues to flow in the next rule(s). so log targets are better defined as first rules (and thus could be inserted lastly).</p>
<p>As a reminder, for a given table (<tt class="docutils literal">filter</tt> by default), rules may be:</p>
<ul class="simple">
<li>appended <em>at the end</em> of the selected chain with <tt class="docutils literal"><span class="pre">-A</span></tt></li>
<li>inserted either at the <em>beginning</em> of the selected chain with <tt class="docutils literal"><span class="pre">-I</span></tt>, or at its position N with <tt class="docutils literal"><span class="pre">-I</span> N</tt></li>
</ul>
<p>See also the <a class="reference external" href="https://wiki.archlinux.org/title/iptables">iptables section</a> in the Arch wiki.</p>
</div>
</div>
<div class="section" id="network-troubleshooting">
<h1><a class="toc-backref" href="#toc-entry-5">Network Troubleshooting</a></h1>
<p>A few pieces of advice/information:</p>
<ul class="simple">
<li>be familiar with <tt class="docutils literal">ip link</tt>, <tt class="docutils literal">ip addr</tt> and <tt class="docutils literal">ip route</tt> (generally used in that order), and <tt class="docutils literal">tcpdump</tt> for the worst cases</li>
<li>to review <em>host-local</em> open ports and sockets, use <tt class="docutils literal">ss</tt> (for <em>socket statistics</em>, replacement of <tt class="docutils literal">netstat</tt>; ex: <tt class="docutils literal">ss <span class="pre">--inet</span> <span class="pre">--listening</span> <span class="pre">-p</span></tt>) or <tt class="docutils literal">nmap</tt> for remote testing</li>
<li>nowadays, many devices change their MAC address regularly, like smartphones do</li>
<li>one may rely on <tt class="docutils literal">netctl</tt>, and create as many profiles as found useful</li>
<li>regularly inspect network-related messages (ex: with <tt class="docutils literal">journalctl <span class="pre">-kf</span></tt>) to detect anomalies such as <tt class="docutils literal">IPv4: martian source 192.168.0.49</tt></li>
<li>interfaces may be associated to any number of IP addresses, this may create surprises</li>
<li>when a network does not work properly, always consider that this device may be faulty, that cables may malfunction, and that power supplies may be culprits</li>
<li>having smart switches may help a lot, to better control one's network (ex: disabling ports, checking statuses, isolating sections, etc.)</li>
<li>beware to DHCP server(s) being left unnoticed; various devices may use them to get a random address and become difficult to spot</li>
<li>netmasks shall not be neglected, for example in routes:</li>
</ul>
<pre class="code bash literal-block">
$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>scope<span class="w"> </span>link<span class="w">
</span>$<span class="w"> </span>ip<span class="w"> </span>route<span class="w">
</span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.0.254<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.0.1<span class="w"> </span>metric<span class="w"> </span><span class="m">1002</span><span class="w">
</span><span class="m">10</span>.0.0.0/8<span class="w"> </span>dev<span class="w"> </span>enp2s0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w">
</span><span class="m">192</span>.168.0.0/16<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>scope<span class="w"> </span>link
</pre>
<p>Here for example, in <tt class="docutils literal">192.168.0.0/16</tt>, <tt class="docutils literal">16</tt> corresponds to the length of <em>the network prefix</em>; the next 16 bits are left to designate hosts, whose addresses therefore range in <tt class="docutils literal"><span class="pre">192.168.[0..254].[1..254]</span></tt>. So <tt class="docutils literal">192.168.0.0/16</tt> includes the <tt class="docutils literal">192.168.27.0/24</tt> network, whereas <tt class="docutils literal">192.168.0.0/24</tt> would not.</p>
<ul class="simple">
<li>go for VLAN only when having reached a first level of correct operation; note that some devices (ex: non-manageable switches) are not able to handle VLAN-tagged packets and may reject or overwrite this information</li>
<li>in some cases, hard reboots / returns to factory settings will fix inexplicable situations; updating to latest firmware may help too (network appliances <em>do</em> have bugs as well!)</li>
<li>secure spare parts (if possible all cables, fibers, devices, power supply, etc. shall exist at least in two copies, tested just after purchased): when the one in operation will fail, the outage will be quickly solved by switching element; the troubleshooting will be easier as well: replace the whole set of equipment, check that everything works again, and try to progress by dichotomy (change half of the elements, and check whether everything remains functional)</li>
<li>purchase only equipment of quality, and treat it gently (ex: use an Uninterruptible Power Supply providing good-quality current)</li>
<li>take notes about the operations that are performed, the detected issues and the current configuration, and put the whole in VCS</li>
<li>check temperature, ventilation and prevent dust accumulation</li>
<li>consider monitoring temperatures, fans, availability, performances</li>
</ul>
</div>
<div class="section" id="see-also">
<h1><a class="toc-backref" href="#toc-entry-6">See Also</a></h1>
<ul class="simple">
<li>Ceylan-Hull's section about scripts for <a class="reference external" href="http://hull.esperide.org/#network-management">network management</a> and for <a class="reference external" href="http://hull.esperide.org/#network-management">firewall configuration</a></li>
<li><a class="reference external" href="Cybersecurity.html">A bit of Cybersecurity</a></li>
</ul>
<p><span class="raw-html"><a name="howtos_bottom"></a></span></p>
</div>
</div>
</body>
</html>
