<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.21.2: https://docutils.sourceforge.io/" />
<title>Ceylan-HOWTOs: About Network Management</title>
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="howtos.css" type="text/css" />
<link href="howtos-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="network-management">
<h1 class="title">Network Management</h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="howtos_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Ceylan HOWTOs</em> <a href="http://howtos.esperide.org">browse latest</a> <a href="Ceylan-HOWTOs-english.pdf">get PDF</a> <a href="#howtos_top">go to top</a> <a href="#howtos_toc">go to toc</a> <a href="#howtos_bottom">go to bottom</a> <a href="Ceylan-HOWTOs-overview-english.html">go to HOWTOs</a> <a href="mailto:about(dash)ceylan-howtos(at)esperide(dot)com?subject=[Ceylan-HOWTOs]%20Remark%20about%20Network%20Management">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="howtos-title.png" id="responsive-image-ultrasmall"></img></span></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body">Copyright (C) 2021-2025 Olivier Boudeville</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body">about (dash) howtos (at) esperide (dot) com</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body">Saturday, November 20, 2021</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body">Saturday, July 12, 2025</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"><a name="howtos_toc"></a></span></p>
<div class="contents local topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><a class="reference internal" href="#top"><strong>Table of Contents</strong></a></p>
<ul class="simple">
<li><a class="reference internal" href="#investigating-network-issues" id="toc-entry-1">Investigating Network Issues</a></li>
<li><a class="reference internal" href="#firewall-management" id="toc-entry-2">Firewall Management</a><ul>
<li><a class="reference internal" href="#configuration-of-a-gateway-to-the-internet" id="toc-entry-3">Configuration of a Gateway to the Internet</a></li>
<li><a class="reference internal" href="#firewall-related-troubleshooting" id="toc-entry-4">Firewall-related Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#network-troubleshooting" id="toc-entry-5">Network Troubleshooting</a></li>
<li><a class="reference internal" href="#dns-management" id="toc-entry-6">DNS Management</a><ul>
<li><a class="reference internal" href="#resolving-host-domain-names" id="toc-entry-7">Resolving Host/Domain Names</a><ul>
<li><a class="reference internal" href="#avoiding-faulty-resolutions" id="toc-entry-8">Avoiding Faulty Resolutions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#caching-dns-requests" id="toc-entry-9">Caching DNS Requests</a></li>
<li><a class="reference internal" href="#adapting-to-various-networks" id="toc-entry-10">Adapting to Various Networks</a></li>
<li><a class="reference internal" href="#wrapping-up" id="toc-entry-11">Wrapping Up</a></li>
</ul>
</li>
<li><a class="reference internal" href="#see-also" id="toc-entry-12">See Also</a></li>
</ul>
</div>
<p><span class="raw-html"></center></span></p>
<div class="section" id="investigating-network-issues">
<h1><a class="toc-backref" href="#toc-entry-1">Investigating Network Issues</a></h1>
<p>Tools like <tt class="docutils literal">ping</tt>, <tt class="docutils literal">traceroute</tt>, <tt class="docutils literal">drill</tt>, <tt class="docutils literal">arp</tt>, etc. are invaluable.</p>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/ip-scan.sh">ip-scan.sh</a> to scans all IPs with any specified prefix, and <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/ip-examine.sh">ip-examine.sh</a> to collect information about a given IP.</p>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/monitor-network.sh">monitor-network.sh</a> to investigate unstable connections.</p>
</div>
<div class="section" id="firewall-management">
<h1><a class="toc-backref" href="#toc-entry-2">Firewall Management</a></h1>
<p>On GNU/Linux, some level of knowledge about <tt class="docutils literal">iptables</tt> is useful, notably if exposing a computer to the Internet; note though that it is to be superseded by <a class="reference external" href="https://wiki.archlinux.org/title/Nftables">nftables</a>.</p>
<p>One should read first the very clear Arch wiki section about <a class="reference external" href="https://wiki.archlinux.org/title/iptables#Basic_concepts">iptables basic concepts</a>. See also <tt class="docutils literal">man <span class="pre">iptables-extensions</span></tt> to understand the extended packet matching modules (triggered with the <tt class="docutils literal"><span class="pre">-m</span></tt> / <tt class="docutils literal"><span class="pre">--match</span></tt> options).</p>
<p>A general rule that we retain, especially for an Internet gateway, is to drop all packets by default, and then only to accept the expected ones explicitly and carefully.</p>
<div class="section" id="configuration-of-a-gateway-to-the-internet">
<h2><a class="toc-backref" href="#toc-entry-3">Configuration of a Gateway to the Internet</a></h2>
<p>Our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.sh">iptables.rules-Gateway.sh</a> script sets up an iptables configuration with various services that can be enabled (e.g. for masquerading, IPTV, different kinds of servers) as an example that we hope is secure enough <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>Please email us if you found otherwise! Refer to the top of this document for that.</td></tr>
</tbody>
</table>
<p>This script expects a settings file to be available as <tt class="docutils literal"><span class="pre">/etc/iptables.settings-Gateway.sh</span></tt> (this file is meant to be sourced, not executed).</p>
<p>An example thereof:</p>
<pre class="code bash literal-block">
<span class="c1"># Local firewall settings.
#
# Meant to be sourced by the iptables.rules-Gateway.sh script.
</span><span class="w">
</span><span class="c1"># Where firewall-related outputs will be written:
</span><span class="nv">log_file</span><span class="o">=</span>/root/.last-gateway-firewall-activation<span class="w">

</span><span class="c1"># Local (LAN) interface, the one we trust:
#lan_if=eth1
</span><span class="nv">lan_if</span><span class="o">=</span>enp2s0<span class="w">

</span><span class="c1"># Internet (WAN) interface, the one we distrust:
</span><span class="w">
</span><span class="c1"># For PPP ADSL connections:
#net_if=ppp0
</span><span class="w">
</span><span class="c1"># For direct connection to a set-top (telecom) box from your provider:
#net_if=eth0
</span><span class="nv">net_if</span><span class="o">=</span>enp4s0<span class="w">

</span><span class="nv">ban_file</span><span class="o">=</span><span class="s2">&quot;/etc/ban-rules.iptables&quot;</span><span class="w">

</span><span class="c1"># As the IPs banned through the ban file above are quite minimal:
</span><span class="nv">use_ban_rules</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w">
</span><span class="c1">#use_ban_rules=&quot;false&quot;
</span><span class="w">
</span><span class="c1"># IP of a test client (to avoid too many logs, selecting only related events):
#test_client_ip=&quot;xxx&quot;
</span><span class="w">
</span><span class="c1"># Enabled input TCP port range for traffic from LAN to gateway:
</span><span class="nv">enable_unfiltered_tcp_range</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="w">

</span><span class="c1"># TCP unfiltered window (e.g. for passive FTP and BEAM port ranges):
</span><span class="nv">tcp_unfiltered_low_port</span><span class="o">=</span><span class="m">50000</span><span class="w">
</span><span class="nv">tcp_unfiltered_high_port</span><span class="o">=</span><span class="m">55000</span><span class="w">

</span><span class="c1"># Tells whether IPTV (TV on the Internet thanks to a box) should be allowed:
</span><span class="nv">enable_iptv</span><span class="o">=</span><span class="nb">false</span><span class="w">

</span><span class="c1"># Tells whether a SMTP server can be used:
</span><span class="nv">enable_smtp</span><span class="o">=</span><span class="nb">false</span><span class="w">

</span><span class="c1"># Typically a set-top box from one's ISP (defined as a possibly log match
# criteria):
</span><span class="w">
</span><span class="c1"># Classical example:
</span><span class="nv">telecom_box</span><span class="o">=</span><span class="s2">&quot;192.168.0.254&quot;</span><span class="w">

</span><span class="c1"># DHT subsection, for P2P exchanges:
# More infos: https://github.com/rakshasa/rtorrent/wiki/Using-DHT
</span><span class="w">
</span><span class="nv">dht_udp_port</span><span class="o">=</span><span class="m">7881</span><span class="w">

</span><span class="c1">#use_dht=&quot;true&quot;
</span><span class="nv">use_dht</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="w">

</span><span class="c1"># One may use a non-standard port:
#ssh_port=22
</span><span class="nv">ssh_port</span><span class="o">=</span><span class="m">22320</span><span class="w">

</span><span class="nv">smtp_port</span><span class="o">=</span><span class="m">25</span><span class="w">

</span><span class="c1"># SMTPS is obsolete:
</span><span class="nv">smtp_secure_port</span><span class="o">=</span><span class="m">465</span><span class="w">

</span><span class="c1"># STARTTLS over SMTP is the proper way of securing SMTP:
</span><span class="nv">msa_port</span><span class="o">=</span><span class="m">587</span><span class="w">

</span><span class="nv">pop3_port</span><span class="o">=</span><span class="m">110</span><span class="w">

</span><span class="c1"># POP3S:
</span><span class="nv">pop3_secure_port</span><span class="o">=</span><span class="m">995</span><span class="w">

</span><span class="nv">imap_port</span><span class="o">=</span><span class="m">143</span><span class="w">
</span><span class="nv">imap_secure_port</span><span class="o">=</span><span class="m">993</span>
</pre>
<p>A script to configure iptables is best integrated to systemd, see the <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-Gateway.service">iptables.rules-Gateway.service</a> file for that (typically to be placed in <tt class="docutils literal">/etc/systemd/system</tt>). Then one may test with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>iptables.rules-Gateway.service
</pre>
<p>and enable it for good with:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>iptables.rules-Gateway.service
</pre>
<p>Note that often these scripts are setup remotely, while being connected thanks to SSH from another host. Care must be taken in order not to lock oneself out of the target server, notably when updating rules (this happens quite easily). We advise to prefer the <tt class="docutils literal">restart</tt> option of our iptables script in order to reduce the risk of &quot;bricking&quot; one's server.</p>
</div>
<div class="section" id="firewall-related-troubleshooting">
<h2><a class="toc-backref" href="#toc-entry-4">Firewall-related Troubleshooting</a></h2>
<p>Use <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables-inspect.sh">iptables-inspect.sh</a> to list the currently-used firewall rules for the chains of the main tables. Like <tt class="docutils literal">iptables <span class="pre">-nL</span> <span class="pre">--line-numbers</span></tt> <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[2]</a>, it displays the number of each rule of a given chain, which allows to add/remove rules more easily, like in:</p>
<pre class="code bash literal-block">
<span class="c1"># Deletes the first rule of the FORWARD chain (of the 'filter' table):
# (note that all the next rules will bear a decremented number afterwards!)
</span>$<span class="w"> </span>iptables<span class="w"> </span>-D<span class="w"> </span>FORWARD<span class="w"> </span><span class="m">1</span>
</pre>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[2]</a></td><td>Note that unfortunately this command does not display interface information, which can be quite misleading; the output of our script is more precise and thus should be preferred.</td></tr>
</tbody>
</table>
<p>Setting environment variables (either through files such as <tt class="docutils literal"><span class="pre">/etc/iptables.settings-Gateway.sh</span></tt> or directly in the shell) is less error-prone; e.g.</p>
<pre class="code bash literal-block">
<span class="o">[</span>...<span class="o">]</span><span class="w">
</span>$<span class="w"> </span><span class="nv">lan_if</span><span class="o">=</span>enp2s0<span class="w">
</span>$<span class="w"> </span><span class="nv">net_if</span><span class="o">=</span>enp4s0<span class="w">
</span>$<span class="w"> </span>iptables<span class="w"> </span>-I<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span><span class="si">${</span><span class="nv">lan_if</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">net_if</span><span class="si">}</span><span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">telecom_box</span><span class="si">}</span><span class="w"> </span>-j<span class="w"> </span>LOG<span class="w">
</span>$<span class="w"> </span>journalctl<span class="w"> </span>-kf<span class="w"> </span>--grep<span class="o">=</span><span class="s2">&quot;IN=.*OUT=.*&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;SRC=</span><span class="si">${</span><span class="nv">telecom_box</span><span class="si">}</span><span class="s2">&quot;</span>
</pre>
<p>To further match packets, one may specify log prefixes, like in:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span>lan.foobar<span class="w"> </span>-j<span class="w"> </span>LOG<span class="w"> </span>--log-prefix<span class="w"> </span><span class="s2">&quot;[VLAN INP FOO]&quot;</span>
</pre>
<p>Note that the <tt class="docutils literal">LOG</tt> target does not intercept a packet, which thus continues to flow in the next rule(s). so log targets are better defined as first rules (and thus could be inserted lastly).</p>
<p>As a reminder, for a given table (<tt class="docutils literal">filter</tt> by default), rules may be:</p>
<ul class="simple">
<li>appended <em>at the end</em> of the selected chain with <tt class="docutils literal"><span class="pre">-A</span></tt> (then of course any previous rule may eclipse it)</li>
<li>inserted either at the <em>beginning</em> of the selected chain with <tt class="docutils literal"><span class="pre">-I</span></tt>, or at its position N with <tt class="docutils literal"><span class="pre">-I</span> N</tt></li>
</ul>
<p>Therefore, just for the sake of testing a safe interface <tt class="docutils literal">foo</tt>, to short-circuit all previous input rules for TCP, one may execute <tt class="docutils literal">iptables <span class="pre">-I</span> INPUT <span class="pre">-i</span> foo <span class="pre">-p</span> tcp <span class="pre">-m</span> state <span class="pre">--state</span> NEW,RELATED,ESTABLISHED <span class="pre">-j</span> ACCEPT</tt> to ensure that the host will accept from now on all (valid) incoming TCP packets; then use <tt class="docutils literal">iptables <span class="pre">-D</span> INPUT 1</tt> to remove that rule and/or, even better, run your stateless firewall initialisation script to ensure that the base configuration has been correctly restored.</p>
<p>Adding/removing rules &quot;safely&quot; from the command-line may be done more easily by rule specification rather than by rule position.</p>
<p>For example removing a given rule can be done:</p>
<ul class="simple">
<li>by first listing all rules thanks to <tt class="docutils literal">iptables <span class="pre">-S</span></tt>, to pick the one of interest</li>
<li>by removing the prefix (typically <tt class="docutils literal"><span class="pre">-A</span></tt>) of the spec, and pasting the rest of that spec after <tt class="docutils literal">iptables <span class="pre">-D</span></tt> in order to remove the corresponding rule</li>
</ul>
<p>Putting back this rule at the first position on its chain instead is just a matter of using  <tt class="docutils literal">iptables <span class="pre">-I</span></tt> and the same shortened spec.</p>
<p>So, for example if wanting to silence an untrusted device (e.g. some &quot;smart&quot; box, a netcam of dubious origin), an approach is to:</p>
<ul class="simple">
<li>determine its MAC address and associate a static IP to it; for example, if using <tt class="docutils literal">dnsmasq</tt>, in <tt class="docutils literal">/etc/dnsmasq.conf</tt> one may define <tt class="docutils literal"><span class="pre">dhcp-host=30:ef:50:36:54:68,10.0.17.203</span></tt>, so that the IP <tt class="docutils literal">10.0.17.203</tt> is always assigned to the device of MAC address <tt class="docutils literal">30:ef:50:36:54:68</tt></li>
<li>define a firewall rule so that one's gateway never forwards outgoing packets from that (local) IP, for example with: <tt class="docutils literal">iptables <span class="pre">-I</span> FORWARD <span class="pre">-s</span> 10.0.17.203/32 <span class="pre">-i</span> my_lan_interface <span class="pre">-j</span> DROP</tt></li>
</ul>
<p>See also:</p>
<ul class="simple">
<li>our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/ef6239b6ca1659ccd479d58b38eb79632b86842f/iptables.rules-Gateway.sh#L674">filtered_local_hosts section</a> of <tt class="docutils literal"><span class="pre">iptables.rules-Gateway.sh</span></tt>, the hosts being filtered out based on the ones specified in the <tt class="docutils literal">setting_file</tt> configuration file</li>
<li>the <a class="reference external" href="https://wiki.archlinux.org/title/iptables">iptables section</a> in the Arch wiki.</li>
</ul>
</div>
</div>
<div class="section" id="network-troubleshooting">
<h1><a class="toc-backref" href="#toc-entry-5">Network Troubleshooting</a></h1>
<p>A few pieces of advice/information:</p>
<ul class="simple">
<li>be familiar with <tt class="docutils literal">ip link</tt>, <tt class="docutils literal">ip addr</tt> and <tt class="docutils literal">ip route</tt> (generally used in that order), and <tt class="docutils literal">tcpdump</tt> for the worst cases</li>
<li>to review <em>host-local</em> open ports and sockets, use:<ul>
<li><tt class="docutils literal">ss</tt> (for <em>socket statistics</em>, replacement of <tt class="docutils literal">netstat</tt>), e.g. to determine which program is running at TCP port #8080: <tt class="docutils literal">ss <span class="pre">--inet</span> <span class="pre">--listening</span> <span class="pre">-np</span> | grep :8080</tt></li>
<li><tt class="docutils literal">netstat</tt> could be for example <tt class="docutils literal">netstat <span class="pre">-ltnp</span> | grep :8080</tt></li>
<li><tt class="docutils literal">lsof <span class="pre">-i</span> :8080</tt></li>
<li><tt class="docutils literal">fuser 8080/tcp</tt>, before looking up the returned PID</li>
</ul>
</li>
<li>for remote testing of open ports and sockets, use <tt class="docutils literal">nmap</tt></li>
<li>nowadays, many devices change their MAC address regularly, like smartphones do</li>
<li>one may rely on <tt class="docutils literal">netctl</tt>, and create as many profiles as found useful</li>
<li>regularly inspect network-related messages (e.g. with <tt class="docutils literal">journalctl <span class="pre">-kf</span></tt>) to detect anomalies such as <tt class="docutils literal">IPv4: martian source 192.168.0.49</tt></li>
<li>interfaces may be associated to any number of IP addresses, this may create surprises</li>
<li>when a network does not work properly, always consider that this device may be faulty, that cables may malfunction, and that power supplies may be culprits</li>
<li>having smart switches may help a lot, to better control one's network (e.g. disabling ports, checking statuses, isolating sections, etc.)</li>
<li>beware to DHCP server(s) being left unnoticed; various devices may use them to get a random address and become difficult to spot; the current leases set up by dnsmaq are stored in <tt class="docutils literal">/var/lib/misc/dnsmasq.leases</tt> (plausible format: <tt class="docutils literal">&lt;ending lease UNIX timestamp&gt; &lt;device MAC address&gt; &lt;assigned IPv4&gt; IPC &lt;assigned IPv4&gt;</tt>, like in <tt class="docutils literal">1748173995 40:ed:00:56:54:68 10.0.77.103 IPC 01:30:ed:00:36:54:68</tt>)</li>
<li>netmasks shall not be neglected, for example in routes:</li>
</ul>
<pre class="code bash literal-block">
$<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>scope<span class="w"> </span>link<span class="w">
</span>$<span class="w"> </span>ip<span class="w"> </span>route<span class="w">
</span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.0.254<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>proto<span class="w"> </span>dhcp<span class="w"> </span>src<span class="w"> </span><span class="m">192</span>.168.0.1<span class="w"> </span>metric<span class="w"> </span><span class="m">1002</span><span class="w">
</span><span class="m">10</span>.0.0.0/8<span class="w"> </span>dev<span class="w"> </span>enp2s0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w">
</span><span class="m">192</span>.168.0.0/16<span class="w"> </span>dev<span class="w"> </span>enp4s0<span class="w"> </span>scope<span class="w"> </span>link
</pre>
<p>Here for example, in <tt class="docutils literal">192.168.0.0/16</tt>, <tt class="docutils literal">16</tt> corresponds to the length of <em>the network prefix</em>; the next 16 bits are left to designate hosts, whose addresses therefore range in <tt class="docutils literal"><span class="pre">192.168.[0..254].[1..254]</span></tt>. So <tt class="docutils literal">192.168.0.0/16</tt> includes the <tt class="docutils literal">192.168.27.0/24</tt> network - whereas <tt class="docutils literal">192.168.0.0/24</tt> would not.</p>
<ul class="simple">
<li>go for VLAN only when having reached a first level of correct operation; note that some devices (e.g. non-manageable switches) are not able to handle VLAN-tagged packets and may reject or overwrite this information</li>
<li>in some cases, hard reboots / returns to factory settings will fix inexplicable situations; updating to latest firmware may help too (network appliances <em>do</em> have bugs as well!)</li>
<li>secure spare parts (if possible all cables, fibers, devices, power supply, etc. shall exist at least in two copies, tested just after purchased): when the one in operation will fail, the outage will be quickly solved by switching element; the troubleshooting will be easier as well: replace the whole set of equipment, check that everything works again, and try to progress by dichotomy (change half of the elements, and check whether everything remains functional)</li>
<li>purchase only equipment of quality, and treat it gently (e.g. use an Uninterruptible Power Supply providing good-quality current)</li>
<li>take notes about the operations that are performed, the detected issues and the current configuration, and put the whole in VCS</li>
<li>check temperature, ventilation and prevent dust accumulation</li>
<li>consider monitoring temperatures, fans, availability, performances</li>
</ul>
</div>
<div class="section" id="dns-management">
<h1><a class="toc-backref" href="#toc-entry-6">DNS Management</a></h1>
<p>The current configuration of resolution can be tested just by using <tt class="docutils literal">ping</tt>, yet tools lie <tt class="docutils literal">drill</tt> (otherwise <tt class="docutils literal">dig</tt>) are of help.</p>
<p>For example to:</p>
<ul class="simple">
<li>resolve a DNS hostname, i.e. to obtain its IP from its name: <tt class="docutils literal">dig +short my.host.in.domain.tld | tail <span class="pre">-n1</span></tt></li>
<li>perform a reverse DNS lookup (thus translating a given IP address into a domain name), one may use: <tt class="docutils literal">drill <span class="pre">-x</span> TARGET_IP</tt>.</li>
<li>get all/most DNS records of a given domain, knowing that <tt class="docutils literal">any</tt> requests (e.g. <tt class="docutils literal">dig +noall +answer +multiline TARGET_DOMAIN any</tt>) may be not honored by some servers, we recommend using our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/list-dns-records.sh">list-dns-records.sh</a> script</li>
</ul>
<div class="section" id="resolving-host-domain-names">
<h2><a class="toc-backref" href="#toc-entry-7">Resolving Host/Domain Names</a></h2>
<p>Apparently the current trend is to rely on <a class="reference external" href="https://wiki.archlinux.org/title/Openresolv">openresolv</a>, which is an implementation of <a class="reference external" href="https://en.wikipedia.org/wiki/Resolvconf">resolvconf</a>.</p>
<p>From <tt class="docutils literal">/etc/resolvconf.conf</tt>, the actual <tt class="docutils literal">/etc/resolv.conf</tt> is generated (run <tt class="docutils literal">resolvconf <span class="pre">-u</span></tt> to apply a new configuration).</p>
<div class="section" id="avoiding-faulty-resolutions">
<h3><a class="toc-backref" href="#toc-entry-8">Avoiding Faulty Resolutions</a></h3>
<p>If having defined a wildcard DNS (e.g. <tt class="docutils literal">*.foobar.org</tt>), by default the <tt class="docutils literal">foobar.org</tt> server (possibly itself a DNS server for LAN clients) may resolve non-existing hosts into its own address (which may be the cause of many surprises), instead of returning the expected <tt class="docutils literal">Name or service not known</tt> error.</p>
<p>To avoid that, ultimately in <tt class="docutils literal">/etc/resolv.conf</tt> there should be &quot;<tt class="docutils literal">search .</tt>&quot; (not having &quot;<tt class="docutils literal">search foobar.org</tt>&quot; will <em>not</em> suffice). This is true for all resolution levels, i.e. for servers and clients alike.</p>
</div>
</div>
<div class="section" id="caching-dns-requests">
<h2><a class="toc-backref" href="#toc-entry-9">Caching DNS Requests</a></h2>
<p>To better cache DNS requests, we chose to have both servers and clients run their instance of <tt class="docutils literal">dnsmasq</tt>, with an extended cache size.</p>
<p><tt class="docutils literal">dnsmasq</tt> will then play the role of a (at least) local DNS server (reading its entries from <tt class="docutils literal">/etc/hosts</tt>), DHCP server if wanted, etc.</p>
<p>For that, ultimately in <tt class="docutils literal">/etc/resolv.conf</tt> (whose regeneration can be triggered manually with <tt class="docutils literal">resolvconf <span class="pre">-u</span></tt>), there should be &quot;<tt class="docutils literal">nameserver 127.0.0.1</tt>&quot; or, more precisely with our conventions:</p>
<pre class="code literal-block">
# Generated by resolvconf
search .
nameserver ::1
nameserver 127.0.0.1
options trust-ad
</pre>
<p>The configuration of dnsmasq itself is defined in <tt class="docutils literal">/etc/dnsmasq.conf</tt>.</p>
<p>Even if the procedures described below may introduce per-network DNS servers, we recommend defining statically from here alternate/fallback DNS servers with at least one <tt class="docutils literal">server=XX.YY.ZZ.TT</tt> line.</p>
<p>For these external &quot;reference&quot; DNS servers, prefer, for privacy rather than for performance, relying not on the ones of your ISP, and try to use non-tracking ones.</p>
</div>
<div class="section" id="adapting-to-various-networks">
<h2><a class="toc-backref" href="#toc-entry-10">Adapting to Various Networks</a></h2>
<p>Many computers, especially laptops, have to adapt to various networks.</p>
<p>One way of doing so is to use <a class="reference external" href="https://wiki.archlinux.org/title/Netctl">netctl</a>, and per-network configuration files like <tt class="docutils literal"><span class="pre">/etc/netctl/my-foobar-network</span></tt> (started with <tt class="docutils literal">netctl start <span class="pre">my-foobar-network</span></tt>). These files may include a directive like <tt class="docutils literal"><span class="pre">DNS=('192.168.0.22')</span></tt> to designate the (here local) DNS server that shall be used. Note that its address will not end up in <tt class="docutils literal">/etc/resolv.conf</tt>, as dnsmasq will be the (only) one interacting with that DNS server - and only when needed (i.e. when a DNS name is not already in its cache).</p>
<p>For that we have to tell <tt class="docutils literal">openresolv</tt> to write the current, network-specific DNS server in a file that dnsmasq will later read. This is of course to be specified in <tt class="docutils literal">/etc/resolvconf.conf</tt>, typically with a <tt class="docutils literal"><span class="pre">dnsmasq_resolv=/etc/dnsmasq-resolv.conf</span></tt> setting.</p>
<p>In order to check that setting, executing <tt class="docutils literal">resolvconf <span class="pre">-u</span></tt> should result in a <tt class="docutils literal"><span class="pre">/etc/dnsmasq-resolv.conf</span></tt> file whose content is, in this example:</p>
<pre class="code literal-block">
# Generated by resolvconf
nameserver 192.168.0.22
</pre>
<p>We just have to tell dnsmasq to read and apply it. This is of course to be done in <tt class="docutils literal">/etc/dnsmasq.conf</tt>, with following lines:</p>
<pre class="code literal-block">
resolv-file=/etc/dnsmasq-resolv.conf

# If ever settings were to be passed from openresolv:
conf-file=/etc/dnsmasq-conf.conf
</pre>
<p>Checking is then a matter of running:</p>
<ul class="simple">
<li><tt class="docutils literal">systemctl status dnsmasq.service</tt>:  <tt class="docutils literal">using nameserver 192.168.0.22#53</tt> shall be listed there (together with any DNS server(s) statically listed in <tt class="docutils literal">/etc/dnsmasq.conf</tt>)</li>
<li><tt class="docutils literal">drill google.com</tt>: then <tt class="docutils literal">SERVER: ::1</tt> or <tt class="docutils literal">SERVER: 127.0.0.1</tt> should be returned, which indicates that a local resolution is taking place indeed</li>
</ul>
</div>
<div class="section" id="wrapping-up">
<h2><a class="toc-backref" href="#toc-entry-11">Wrapping Up</a></h2>
<p>So <tt class="docutils literal">/etc/resolvconf.conf</tt> could be:</p>
<pre class="code literal-block">
resolv_conf=/etc/resolv.conf
name_servers=&quot;::1 127.0.0.1&quot;
resolv_conf_options=&quot;trust-ad&quot;
dnsmasq_conf=/etc/dnsmasq-conf.conf
dnsmasq_resolv=/etc/dnsmasq-resolv.conf
search_domains=.
</pre>
<p>which should result in a <tt class="docutils literal">resolv.conf</tt> like:</p>
<pre class="code literal-block">
# Generated by resolvconf
search .
nameserver ::1
nameserver 127.0.0.1
options trust-ad
</pre>
</div>
</div>
<div class="section" id="see-also">
<h1><a class="toc-backref" href="#toc-entry-12">See Also</a></h1>
<ul class="simple">
<li>Ceylan-Hull's section about scripts for <a class="reference external" href="http://hull.esperide.org/#network-management">network management</a> and for <a class="reference external" href="http://hull.esperide.org/#network-management">firewall configuration</a></li>
<li><a class="reference external" href="Cybersecurity.html">A bit of Cybersecurity</a></li>
<li>to test based on a non-filtering iptables configuration, one may take inspiration from our <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Hull/blob/master/iptables.rules-FullDisabling.sh">iptables.rules-FullDisabling.sh</a> script</li>
</ul>
<p><span class="raw-html"><a name="howtos_bottom"></a></span></p>
</div>
</div>
</body>
</html>
